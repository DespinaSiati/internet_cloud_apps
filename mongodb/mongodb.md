% Διαδικτυακές και Νεφοϋπολογιστικές Εφαρμογές
% Αν. Καθηγητής Π. Λουρίδας
% Οικονομικό Πανεπιστήμιο Αθηνών

# MongoDB

## Εισαγωγή

* Η MongoDB είναι η πιο δημοφιλής από τις μη σχεσιακές βάσεις
  δεδομένων (NoSQL databases).

* Ως τέτοια, υιοθετεί ένα ριζικά διαφορετικό τρόπο αποθήκευσης
  δεδομένων και μία πολύ διαφορετική φιλοσοφία από τις σχεσιακές
  βάσεις.

* Είναι κατάλληλη για την αποθήκευση τεράστιων όγκων δεδομένων, αρκεί
  να είμαστε πιστοί στη φιλοσοφία που τη διέπει.

* Τα παρακάτω περιέχουν υλικό από:
  * [Thinking in Documents: Part 1](https://www.mongodb.com/blog/post/thinking-documents-part-1).
  * [Thinking in Documents: Part 2](https://www.mongodb.com/blog/post/thinking-documents-part-2).


# Βασικές αρχές 

## Γενικά

* Η MongoDB αποθηκεύει *έγγραφα* (documents) σε *συλλογές*
  (collections).

* Οι συλλογές αποθηκεύονται σε βάσεις δεδομένων.

* Μια βάση δεδομένων λοιπόν είναι μια συλλογή εγγράφων.


## Σχεσιακές βάσεις και MongoDB

| RDBMS    | MongoDB                        |
|----------|--------------------------------|
| Database | Database                       | 
| Table    | Collection                     |
| Row      | Document                       |
| Index    | Index                          |
| JOIN     | Embedded Document or Reference |


## Σχεσιακή απεικόνιση δεδομένων (1)

Persons

| Pers ID | Surname   | First Name | City     |
|---------+-----------+------------+----------|
|       0 | Miller    | Paul       | London   |
|       1 | Ortega    | Alvaro     | Valencia |
|       2 | Huber     | Urs        | Zurich   |
|       3 | Blanc     | Gaston     | Paris    |
|       4 | Bertolini | Fabrizio   | Rome     |


## Σχεσιακή απεικόνιση δεδομένων (2)

Cars

| Car ID | Model       | Year |  Value | Pers ID |
|--------|-------------|------|--------|---------|
|    101 | Bentley     | 1973 | 100000 |       0 |
|    102 | Rolls Royce | 1965 | 330000 |       0 |
|    103 | Peugeot     | 1993 |    500 |       3 |
|    104 | Ferrari     | 2005 | 150000 |       4 |
|    105 | Renault     | 1998 |   2000 |       3 |
|    106 | Renault     | 2001 |   7000 |       3 |
|    107 | Smart       | 1999 |   2000 |       2 |


## Απεικόνιση σε MongoDB

```javascript
{
  first_name: "Paul",
  surname: "Miller",
  city: "London",
  location: [45.123, 47.232],
  cars: [
    { model: "Bentley",
      year: 1973,
      value: 100000,
      / * ... */
    },
    { model: "Rolls Royce",
      year: 1965,
      value: 330000, 
      /* ... */
    },
  ]
}
```

## Blog: σχεσιακή απεικόνιση

<img src="blog_relational.png" width="600px"/>


## Blog: MongoDB

<img src="blog_mongodb.png" height="500px"/>


## Βασικά χαρακτηριστικά εγγράφων

* Tο σύνολο της πληροφορίας ενός εγγράφου είναι προσπελάσιμο σε
  μία κλήση στη βάση, αντί να απαιτούνται joins.

* Αφού τα έγγραφα είναι αυτοτελή, ο διαμοιρασμός της βάσης σε
  πολλαπλούς κόμβους είναι ευκολότερη από ό,τι στις σχεσιακές βάσεις.

* Δεν υπάρχει πρόβλημα απόδοσης λόγω joins.


## Μοντελοποίηση συσχετίσεων

* Υπάρχουν δύο τρόποι να μοντελοποιήσουμε συσχετίσεις με τη MongoDB:
  * ενσωμάτωση (embedding)
  * αναφορά (referencing)

* Η κάθε μία είναι κατάλληλη σε συγκεκριμένες περιπτώσεις.


## Ενσωμάτωση: ενδείξεις

* Αν τα δεδομένα μας έχουν σχέση 1:1 ή 1:n, και τα «πολλά» αντικείμενα
  τα βλέπουμε μαζί με το ένα, τότε μπορούμε να τα ενσωματώσουμε στο
  γονέα τους.

* Αυτό επίσης ταιριάζει καλά όταν ένα αντικείμενο *ανήκει* σε ένα
  άλλο.

* Για παράδειγμα, η τιμολόγηση ενός προϊόντος μπορεί να ενσωματωθεί
  στο προϊόν:
  * αν είναι μοναδική και αφορά συγκεκριμένο προϊόν
  * αν σβήνοντας το προϊόν δεν έχει νόημα ύπαρξης η τιμολόγησή του


## Ενσωμάτωση: αντενδείξεις

* Διαβάζουμε συχνά ένα έγγραφο, αλλά όχι ένα ενσωματωμένο του τμήμα.
  Τότε με το να το έχουμε ενσωματώσει, απλώς διαβάζουμε κάθε φορά
  περιττά πράγματα.

* Ένα τμήμα του εγγράφου ενημερώνεται συχνά, ενώ το υπόλοιπο μένει
  στατικό.

* Το έγγραφο ξεπερνά τα όρια της MongoDB (16 GB ανά έγγραφο).


## Αναφορά: ενδείξεις

* Με τη χρήση αναφορών πετυχαίνουμε κάποιου είδους κανονικοποίηση στα
  δεδομένα μας.

* Χρησιμοποιούμε αναφορές αν αναφερόμαστε σε ένα αντικείμενο από
  πολλά διαφορετικά αντικείμενα.

* Χρησιμοποιούμε αναφορές για να αναπαραστήσουμε σχέσεις m:n.

* Χρησιμοποιούμε αναφορές για την αναπαράσταση μεγάλων ιεραρχικών
  μοντέλων.

* Χρησιμοποιούμε αναφορές όταν τα κέρδη σε ταχύτητα ανάγνωσης δεν
  ισορροπούν τις συνέπειες της αποκανονικοποίησης.


## Αναφορά: αντενδείξεις

* Δεν χρησιμοποιούμε αναφορές όταν μας πειράζει η πτώση στην ταχύτητα
  ανάγνωσης, αφού για κάθε αναφορά πρέπει να διαβάσουμε από τη βάση.

* Δεν χρησιμοποιούμε αναφορές όταν η αποκανονικοποίηση των δεδομένων
  μας δημιουργεί προβλήματα.


## Διαφορετικοί στόχοι

* Μία σχεσιακή βάση έχει ως βασικό στόχο τη βελτιστοποίηση της
  αποθήκευσης των δεδομένων. 

* Η MongoDB έχει ως βασικό στόχο τη βελτιστοποίηση της πρόσβασης στα
  δεδομένα από την εφαρμογή.

* Συνεπώς, η MongoDB θεωρεί ότι το κόστος ανάπτυξης και ο χρόνος
  ανάπτυξης είναι πιο σημαντικά από το κόστος αποθήκευσης (αν και ο
  χρόνος και το κόστος ανάπτυξης δεν μειώνονται πάντα με τη χρήση
  MongoDB).


## Δοσοληψίες στη MongoDB

* H MongoDB προσφέρει εγγυήσεις ACID *σε επίπεδο εγγράφου*.

* Αυτό συμπεριλαμβάνει ενσωματωμένους πίνακες και έγγραφα.

* Η MongoDB *δεν* δίνει εγγυήσεις ACID όταν επιδρούμε σε παραπάνω από
  ένα έγγραφο, στην ίδια ή σε διαφορετικές συλλογές.

* Αν πραγματικά χρειαζόμαστε κάτι τέτοιο, πρέπει να το υλοποιήσουμε
  προγραμματιστικά εμείς, για λεπτομέρειες βλ.
  [εδώ](https://docs.mongodb.com/manual/tutorial/perform-two-phase-commits/).

## ACID

* A: Atomicity. Κάθε δοσοληψία είναι «όλα ή τίποτε».

* C: Consistency. Κάθε δοσοληψία πρέπει να φέρνει τη βάση από μία
  συνεπή κατάσταση σε μία άλλη.

* I: Isolation. Αν εκτελούνται πολλές δοσοληψίες ταυτόχρονα, το
  αποτέλεσμα είναι το ίδιο με το να εκτελούνται σειριακά.

* D: Durability. Αν μια δοσοληψία οριστικοποιηθεί, θα παραμείνει
  οριστικοποιημένη, ό,τι και να γίνει (διακοπή ρεύματος, λάθη,
  crashes).


