<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang xml:lang>
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="author" content="Αν. Καθηγητής Π. Λουρίδας" />
  <title>Διαδικτυακές και Νεφοϋπολογιστικές Εφαρμογές</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <style type="text/css">body {
margin: auto;
padding-right: 1em;
padding-left: 1em;
max-width: 60%; border-left: 1px solid black;
border-right: 1px solid black;
color: black;
font-family: 'Lucida Sans Unicode', 'Lucida Grande', sans-serif;
font-size: 100%;
line-height: 140%;
color: #333; }
pre {
border: 1px dotted gray;
background-color: #ececec;
color: #1111111;
padding: 0.5em;
}
code {
font-family: 'Lucida Console', Monaco, monospace;
font-size: 100%;
}
a {
color: #336666;
} h1 a, h2 a, h3 a, h4 a, h5 a { text-decoration: none;
color: #7a5ada; }
h1, h2, h3, h4, h5 {
font-family: Roboto;
font-weight: bold;
}
h1 {
font-size: 130%;
padding: 0.5em;
border-bottom: 1px dotted black;
}
h2 {
font-size: 110%;
}
h3 {
font-size: 95%;
}
h4 {
font-size: 90%;
font-style: italic;
}
h5 {
font-size: 90%;
font-style: italic;
}
h1.title {
font-size: 200%;
font-weight: bold;
padding-top: 0.2em;
padding-bottom: 0.2em;
text-align: left;
border: none;
}
dt code {
font-weight: bold;
}
dd p {
margin-top: 0;
}
#footer {
padding-top: 1em;
font-size: 70%;
color: gray;
text-align: center;
}
table {
margin-bottom: 2em;
border-bottom: 1px solid #ddd;
border-right: 1px solid #ddd;
border-spacing: 0;
border-collapse: collapse;
}
table th {
padding: .2em 1em;
background-color: #eee;
border-top: 1px solid #ddd;
border-left: 1px solid #ddd;
}
table td {
padding: .2em 1em;
border-top: 1px solid #ddd;
border-left: 1px solid #ddd;
vertical-align: top;
}
</style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<header id="title-block-header">
<h1 class="title">Διαδικτυακές και Νεφοϋπολογιστικές Εφαρμογές</h1>
<p class="author">Αν. Καθηγητής Π. Λουρίδας</p>
<p class="date">Οικονομικό Πανεπιστήμιο Αθηνών</p>
</header>
<nav id="TOC">
<ul>
<li><a href="#object-relational-mapping">Object Relational Mapping</a><ul>
<li><a href="#γενικά">Γενικά</a></li>
<li><a href="#επιπλέον-προβλήματα">Επιπλέον προβλήματα</a></li>
<li><a href="#απεικόνιση-αντικειμένων-οντοτήτων">Απεικόνιση αντικειμένων-οντοτήτων</a></li>
<li><a href="#sqlalchemy">SQLAlchemy</a></li>
<li><a href="#εγκατάσταση-ipython">Εγκατάσταση IPython</a></li>
</ul></li>
<li><a href="#microblog-με-flask-sqlalchemy">Microblog με Flask-SQLAlchemy</a><ul>
<li><a href="#γενικά-1">Γενικά</a></li>
<li><a href="#δημιουργία-περιβάλλοντος">Δημιουργία περιβάλλοντος</a></li>
<li><a href="#προοίμιο-εφαρμογής">Προοίμιο εφαρμογής</a></li>
<li><a href="#μοντέλο-βάσης">Μοντέλο βάσης</a></li>
<li><a href="#δημιουργία-βάσης">Δημιουργία βάσης</a></li>
<li><a href="#διαγραφή-βάσης">Διαγραφή Βάσης</a></li>
<li><a href="#εισαγωγή-δεδομένων">Εισαγωγή δεδομένων</a></li>
<li><a href="#αναζήτηση-δεδομένων">Αναζήτηση δεδομένων</a></li>
<li><a href="#εμφάνιση-εντολών-sql">Εμφάνιση Εντολών SQL</a></li>
<li><a href="#διαγραφή-δεδομένων">Διαγραφή δεδομένων</a></li>
<li><a href="#εμφάνιση-αναρτήσεων">Εμφάνιση αναρτήσεων</a></li>
<li><a href="#προσθήκη-ανάρτησης">Προσθήκη ανάρτησης</a></li>
<li><a href="#λοιπές-λειτουργίες-και-εκκίνηση">Λοιπές λειτουργίες και εκκίνηση</a></li>
</ul></li>
<li><a href="#microblog-με-πολλαπλούς-χρήστες">Microblog με Πολλαπλούς Χρήστες</a><ul>
<li><a href="#γενικά-2">Γενικά</a></li>
<li><a href="#δημιουργία-περιβάλλοντος-1">Δημιουργία περιβάλλοντος</a></li>
<li><a href="#προοίμιο-εφαρμογής-1">Προοίμιο εφαρμογής</a></li>
<li><a href="#μοντέλο-βάσης-αναρτήσεις">Μοντέλο βάσης: αναρτήσεις</a></li>
<li><a href="#κώδικας-αναρτήσεων">Κώδικας αναρτήσεων</a></li>
<li><a href="#μοντέλο-βάσης-χρήστες">Μοντέλο βάσης: χρήστες</a></li>
<li><a href="#κώδικας-χρηστών">Κώδικας χρηστών</a></li>
<li><a href="#δημιουργία-βάσης-1">Δημιουργία βάσης</a></li>
<li><a href="#εισαγωγή-χρηστών">Εισαγωγή χρηστών</a></li>
<li><a href="#εμφάνιση-αναρτήσεων-1">Εμφάνιση αναρτήσεων</a></li>
<li><a href="#προσθήκη-ανάρτησης-1">Προσθήκη ανάρτησης</a></li>
<li><a href="#κώδικας-προσθήκης">Κώδικας προσθήκης</a></li>
<li><a href="#είσοδος">Είσοδος</a></li>
<li><a href="#έξοδος">Έξοδος</a></li>
<li><a href="#βασικό-πρότυπο-εμφάνισης">Βασικό πρότυπο εμφάνισης</a></li>
<li><a href="#εμφάνιση-αναρτήσεων-2">Εμφάνιση αναρτήσεων</a></li>
<li><a href="#κώδικας-εμφάνισης">Κώδικας εμφάνισης</a></li>
<li><a href="#είσοδος-1">Είσοδος</a></li>
<li><a href="#κώδικας-εισόδου">Κώδικας εισόδου</a></li>
<li><a href="#στυλ">Στυλ</a></li>
<li><a href="#εκκίνηση">Εκκίνηση</a></li>
</ul></li>
<li><a href="#χειρισμός-κωδικών">Χειρισμός Κωδικών</a><ul>
<li><a href="#το-πρόβλημα">Το πρόβλημα</a></li>
<li><a href="#bcrypt">Bcrypt</a></li>
<li><a href="#εγκατάσταση-bcrypt">Εγκατάσταση bcrypt</a></li>
<li><a href="#δημιουργία-περιβάλλοντος-2">Δημιουργία περιβάλλοντος</a></li>
<li><a href="#δημιουργία-βάσης-2">Δημιουργία βάσης</a></li>
<li><a href="#φόρμα-εγγραφής">Φόρμα εγγραφής</a></li>
<li><a href="#κώδικας-φόρμας">Κώδικας φόρμας</a></li>
<li><a href="#εγγραφή-χρηστών">Εγγραφή χρηστών</a></li>
<li><a href="#κώδικας-εγγραφής">Κώδικας εγγραφής</a></li>
<li><a href="#είσοδος-2">Είσοδος</a></li>
<li><a href="#βασικό-πρότυπο-εμφάνισης-1">Βασικό πρότυπο εμφάνισης</a></li>
</ul></li>
<li><a href="#mysql">MySQL</a><ul>
<li><a href="#γενικά-3">Γενικά</a></li>
<li><a href="#δημιουργία-περιβάλλοντος-3">Δημιουργία περιβάλλοντος</a></li>
<li><a href="#εγκατάσταση-mysql">Εγκατάσταση MySQL</a></li>
<li><a href="#εγκατάσταση-οδηγού">Εγκατάσταση οδηγού</a></li>
<li><a href="#δημιουργία-βάσης-3">Δημιουργία βάσης</a></li>
<li><a href="#ρύθμιση-για-χρήση-mysql">Ρύθμιση για χρήση MySQL</a></li>
<li><a href="#δημιουργία-πινάκων">Δημιουργία πινάκων</a></li>
<li><a href="#δημιουργία-πινάκων-1">Δημιουργία πινάκων</a></li>
<li><a href="#επόμενα-βήματα">Επόμενα βήματα</a></li>
</ul></li>
</ul>
</nav>
<h1 id="object-relational-mapping">Object Relational Mapping</h1>
<h2 id="γενικά">Γενικά</h2>
<ul>
<li><p>Οι περισσότερες βάσεις δεδομένουν χρησιμοποιούν το <em>σχεσιακό μοντέλο</em> (relational model).</p></li>
<li><p>Στα προγράμματα που γράφουμε όμως, δεν έχουμε σχέσεις. Έχουμε αντικείμενα και άλλες δομές δεδομένων.</p></li>
<li><p>Πρέπει λοιπόν να μεταφράζουμε μεταξύ των σχέσεων και των αντικειμένων του προγράμματός μας.</p></li>
</ul>
<h2 id="επιπλέον-προβλήματα">Επιπλέον προβλήματα</h2>
<ul>
<li><p>Στις σχεσιακές βάσεις δεδομένων χρησιμοποιούμε SQL.</p></li>
<li><p>Στα προγράμματά μας χρησιμοποιούμε άλλες γλώσσες.</p></li>
<li><p>Πρέπει λοιπόν ταυτόχρονα να χρησιμοποιούμε SQL συν ό,τι άλλες γλώσσες χρειαζόμαστε.</p></li>
<li><p>Ο κώδικας SQL ελέγχεται μόνο κατά τη διάρκεια εκτέλεσης του προγράμματος (runtime).</p></li>
</ul>
<h2 id="απεικόνιση-αντικειμένων-οντοτήτων">Απεικόνιση αντικειμένων-οντοτήτων</h2>
<ul>
<li><p>Η <em>απεικόνιση αντικεμένων-οντοτήτων</em> (Object Relational Mapping, ORM) είναι μια σειρά τεχνολογιών με τις οποίες τα αντικείμενα που χρησιμοποιούμε στην εφαρμογή μας μεταφράζονται αυτομάτως σε σχέσεις.</p></li>
<li><p>Υπάρχουν πολλές υλοποιήσεις, σε πολλές γλώσσες.</p></li>
</ul>
<h2 id="sqlalchemy">SQLAlchemy</h2>
<ul>
<li><p>Η πιο δημοφιλής βιβλιοθήκη για ORM στην Python είναι η <a href="http://www.sqlalchemy.org/">SQLAlchemy</a>.</p></li>
<li><p>Αν θέλουμε να τη χρησιμοποιήσουμε με το Flask, μπορούμε να εγκαταστήσουμε το πακέτο <a href="http://flask-sqlalchemy.pocoo.org/">Flask-SQLAlchemy</a>.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="ex">pip</span> install flask-sqlalchemy</a></code></pre></div></li>
</ul>
<h2 id="εγκατάσταση-ipython">Εγκατάσταση IPython</h2>
<ul>
<li><p>Θα χρειαστεί να χρησιμοποιήσουμε αρκετές φορές τη γραμμή εντολών της Python.</p></li>
<li><p>Επειδή η γραμμή εντολών της Python είναι λίγο δύσχρηστη, στην πράξη χρησιμοποιούμε το εργαλείο <a href="https://ipython.org/">IPython</a>.</p></li>
<li><p>Για να το εγκαταστήσουμε δίνουμε:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="ex">pip</span> install ipython</a></code></pre></div></li>
<li><p>Στο εξής μπορούμε να δίνουμε <code>ipython</code> για να ξεκινάμε μία γραμμή εντολών της Python.</p></li>
</ul>
<div class="notes">
<p>Το IPython έχει πολλές δυνατότητες που κάνουν την αλληλεπίδραση με την Python ευκολότερη. Επιγραμματικά:</p>
<ul>
<li><p>Συμπλήρωση εντολών (command line completion). Καθώς πληκτρολογούμε κάτι σε Python, μπορούμε να πατάμε Tab οπότε θα φαίνονται η διαθέσιμες επιλογές για τη συμπλήρωση της εντολής μας.</p></li>
<li><p>Πλήρες ιστορικό εντολών (command history). Μπορούμε να πλοηγηθούμε στις εντολές που έχουμε δώσει χρησιμοποιώντας τα βελάκια άνω και κάτω.</p></li>
<li><p>Αντιγραφή και επικόλληση (copy and paste). Μπορούμε να αντιγράφουμε εύκολα κώδικα από και προς το IPython.</p></li>
</ul>
<p>Για μία σύντομη εισαγωγή, μπορείτε να δείτε την <a href="http://ipython.readthedocs.io/en/stable/interactive/tutorial.html">online τεκμηρίωση</a>.</p>
</div>
<h1 id="microblog-με-flask-sqlalchemy">Microblog με Flask-SQLAlchemy</h1>
<h2 id="γενικά-1">Γενικά</h2>
<ul>
<li><p>Θα μετατρέψουμε την εφαρμογή που γράψαμε στην προηγούμενη διάλεξη ώστε να χρησιμοποιεί SQLAlchemy.</p></li>
<li><p>Θα δούμε ότι με τον τρόπο αυτό δεν θα γράψουμε καθόλου κώδικα SQL.</p></li>
</ul>
<h2 id="δημιουργία-περιβάλλοντος">Δημιουργία περιβάλλοντος</h2>
<ul>
<li><p>Δημιουργείστε την παρακάτω δομή καταλόγων.</p></li>
<li><p>Στους καταλόγους <code>static</code> και <code>templates</code> θα αντιγράψετε τα αρχεία που δημιουργήσατε στην έκδοση του microblog που είδαμε στην πρώτη διάλεξη.</p>
<pre><code>/flaskr_orm_1
    /static
    /templates</code></pre></li>
</ul>
<h2 id="προοίμιο-εφαρμογής">Προοίμιο εφαρμογής</h2>
<ul>
<li><p>Στον κατάλογο <code>flaskr_orm_1</code> δημιουργείστε ένα αρχείο <code>flaskr.py</code>, στο οποίο θα γράφετε αυτά που ακολουθούν.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="im">from</span> flask <span class="im">import</span> Flask</a>
<a class="sourceLine" id="cb4-2" data-line-number="2"><span class="im">from</span> flask <span class="im">import</span> Flask, request, session, g, redirect, url_for, abort, <span class="op">\</span></a>
<a class="sourceLine" id="cb4-3" data-line-number="3">     render_template, flash</a>
<a class="sourceLine" id="cb4-4" data-line-number="4"></a>
<a class="sourceLine" id="cb4-5" data-line-number="5"><span class="im">from</span> flask_sqlalchemy <span class="im">import</span> SQLAlchemy</a>
<a class="sourceLine" id="cb4-6" data-line-number="6"></a>
<a class="sourceLine" id="cb4-7" data-line-number="7">app <span class="op">=</span> Flask(<span class="va">__name__</span>)</a>
<a class="sourceLine" id="cb4-8" data-line-number="8">app.config.from_object(<span class="va">__name__</span>)</a>
<a class="sourceLine" id="cb4-9" data-line-number="9"></a>
<a class="sourceLine" id="cb4-10" data-line-number="10">app.config.update(<span class="bu">dict</span>(</a>
<a class="sourceLine" id="cb4-11" data-line-number="11">    SECRET_KEY<span class="op">=</span><span class="st">'development key'</span>,</a>
<a class="sourceLine" id="cb4-12" data-line-number="12">    USERNAME<span class="op">=</span><span class="st">'admin'</span>,</a>
<a class="sourceLine" id="cb4-13" data-line-number="13">    PASSWORD<span class="op">=</span><span class="st">'default'</span>,</a>
<a class="sourceLine" id="cb4-14" data-line-number="14">    SQLALCHEMY_DATABASE_URI <span class="op">=</span> <span class="st">'sqlite:///flaskr.db'</span>,</a>
<a class="sourceLine" id="cb4-15" data-line-number="15">    SQLALCHEMY_TRACK_MODIFICATIONS <span class="op">=</span> <span class="va">False</span></a>
<a class="sourceLine" id="cb4-16" data-line-number="16">))</a>
<a class="sourceLine" id="cb4-17" data-line-number="17"></a>
<a class="sourceLine" id="cb4-18" data-line-number="18">app.config.from_envvar(<span class="st">'FLASKR_SETTINGS'</span>, silent<span class="op">=</span><span class="va">True</span>)</a>
<a class="sourceLine" id="cb4-19" data-line-number="19"></a>
<a class="sourceLine" id="cb4-20" data-line-number="20">db <span class="op">=</span> SQLAlchemy(app)</a></code></pre></div></li>
</ul>
<div class="notes">
<p>Το προοίμιο είναι το ίδιο, με μόνες διαφορές τις εξής:</p>
<ul>
<li><p>Χρησιμοποιούμε και τη βιβλιοθήκη SQLAlchemy, οπότε απαιτείται το κατάλληλο <code>import</code>.</p></li>
<li><p>Οι ρυθμίσεις για τη βάση αλλάζουν. Το <code>SQLALCHEMY_DATABASE_URI</code> δείχνει την τοποθεσία της βάσης. Στη συγκεκριμένη περίπτωση, θα είναι το αρχείο <code>flaskr.db</code> στον κατάλογο της εφαρμογής μας.</p></li>
<li><p>Η ρύθμιση <code>SQLALCHEMY_TRACK_MODIFICATIONS = False</code> είναι μια τεχνική λεπτομέρεια και δεν χρειάζεται να μας απασχολήσει τώρα.</p></li>
<li><p>Η γραμμή <code>db = SQLAlchemy(app)</code> δημιουργεί το αντικείμενο <code>db</code> με το οποίο θα αλληλεπιδρούμε με τη βάση δεδομένων μας.</p></li>
</ul>
</div>
<h2 id="μοντέλο-βάσης">Μοντέλο βάσης</h2>
<ul>
<li><p>Αυτή τη φορά δεν θα χρειαστεί να γράψουμε κώδικα SQL για τον ορισμό του πίνακα <code>entries</code>.</p></li>
<li><p>Ο πίνακας θα οριστεί μέσω αντίστοιχης κλάσης Python.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="kw">class</span> Entry(db.Model):</a>
<a class="sourceLine" id="cb5-2" data-line-number="2">    __tablename__ <span class="op">=</span> <span class="st">'entries'</span></a>
<a class="sourceLine" id="cb5-3" data-line-number="3">    <span class="bu">id</span> <span class="op">=</span> db.Column(db.Integer, primary_key<span class="op">=</span><span class="va">True</span>)</a>
<a class="sourceLine" id="cb5-4" data-line-number="4">    title <span class="op">=</span> db.Column(db.String(<span class="dv">120</span>), nullable<span class="op">=</span><span class="va">False</span>)</a>
<a class="sourceLine" id="cb5-5" data-line-number="5">    text <span class="op">=</span> db.Column(db.Text(), nullable<span class="op">=</span><span class="va">False</span>)</a>
<a class="sourceLine" id="cb5-6" data-line-number="6"></a>
<a class="sourceLine" id="cb5-7" data-line-number="7">    <span class="kw">def</span> <span class="fu">__repr__</span>(<span class="va">self</span>):</a>
<a class="sourceLine" id="cb5-8" data-line-number="8">        <span class="cf">return</span> <span class="st">'&lt;Entry </span><span class="sc">%r</span><span class="st"> </span><span class="sc">%r</span><span class="st">&gt;'</span> <span class="op">%</span> (<span class="va">self</span>.title, <span class="va">self</span>.text)</a></code></pre></div></li>
</ul>
<div class="notes">
<p>Στο SQLAlchemy θα απεικονίζουμε τους πίνακες της βάσης μέσω κλάσεων στην Python. Οι κλάσεις θα πρέπει να είναι απόγονοι της κλάσης <code>db.Model</code>. Η αντιστοίχηση μεταξύ της κλάσης και του πίνακα στη βάση δεδομένων γίνεται με την ιδιότητα <code>__tablename__</code>. Προσέξτε τη σύμβαση στην ονοματολογία: τα ονόματα των κλάσεων στις γλώσσες προγραμμματισμού είναι στον <em>ενικό</em>. Τα ονόματα των πινάκων είναι συνήθως στον <em>πληθυντικό</em>.</p>
<p>Στη συνέχεια, ορίζουμε της στήλες του πίνακα μέσω ιδιοτήτων. Ο πίνακας <code>entries</code> θέλουμε να έχει ως στήλες έναν κωδικό (<code>id</code>), έναν τίτλο (<code>title</code>), και ένα κείμενο (<code>text</code>). Το κάθε ένα από αυτά ορίζεται μέσω κατάλληλης κλήσης της μεθόδου <code>db.Column()</code>. Η πρώτη παράμετρος της μεθόδου δίνει τον τύπο της στήλης και επιπλέον παράμετροι δίνουν ιδιότητες, όπως αν πρόκειται για κλειδί, αν επιτρέπονται οι τιμές null, κ.λπ. Περισσότερες πληροφορίες μπορείτε να βρείτε στην <a href="http://flask-sqlalchemy.pocoo.org/2.3/models/#simple-example">τεκμηρίωση του Flask-SQLAlchemy</a>. Αν θέλετε να εμβαθύνετε, δείτε την <a href="http://docs.sqlalchemy.org/en/latest/index.html">τεκμηρίωση του SQLAlchemy</a>.</p>
<p>Η μέθοδος <code>__repr__()</code> θα μας εκτυπώνει μια αναπάρασταση του κάθε αντικειμένου τύπου <code>Entry</code>. Μοιάζει με τη μέθοδο <code>__str__</code>, αλλά ενώ η μέθοδος <code>__str__</code> δημιουργεί απλώς μια συμβολοσειρά από το αντικείμενό μας, η μέθοδος <code>__repr__</code> δημιουργεί μια συμβολοσειρά η οποία περιέχει όλη την πληροφορία που χρειαζόμαστε για να το κατασκευάσουμε, αν θέλουμε. Αντίστοιχα με το <code>%s</code>, το οποίο όταν εμφανίζεται σε μία συμβολοσειρά θα αντικασταθεί με μία κλήση της <code>__str__</code>, το <code>%r</code> θα αντικατασταθεί με μία κλήση της <code>__repr__</code>.</p>
</div>
<h2 id="δημιουργία-βάσης">Δημιουργία βάσης</h2>
<ul>
<li><p>Έχοντας γράψει τον παραπάνω κώδικα, μπορούμε να δημιουργήσουμε τη βάση μας κατ’ ευθείαν από μία γραμμή εντολών Python.</p></li>
<li><p>Ξεκινάμε την Python μέσα στον κατάλογο <code>flaskr_orm_1</code> πληκτρολογόντας <code>python</code>, ή καλύτερα <code>ipython</code>.</p></li>
<li><p>Για να είναι εμφανές ότι μιλάμε για τη γραμμή εντολών της Python, η είσοδός μας και η έξοδός μας εκεί θα ξεκινούν με <code>&gt;&gt;&gt;</code> σε ό,τι ακολουθεί.</p></li>
<li><p>Στη συνέχεια γράφουμε:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="op">&gt;&gt;&gt;</span> <span class="im">from</span> flaskr <span class="im">import</span> db</a>
<a class="sourceLine" id="cb6-2" data-line-number="2"><span class="op">&gt;&gt;&gt;</span> db.create_all()</a></code></pre></div></li>
</ul>
<h2 id="διαγραφή-βάσης">Διαγραφή Βάσης</h2>
<ul>
<li><p>Αν θέλουμε να διαγράψουμε τους πίνακες μιας βάσης δίνουμε:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="op">&gt;&gt;&gt;</span> db.drop_all()</a></code></pre></div></li>
</ul>
<h2 id="εισαγωγή-δεδομένων">Εισαγωγή δεδομένων</h2>
<ul>
<li><p>Τώρα μπορούμε να χειριστούμε πλήρως τη βάση μας από τη γραμμή εντολών της Python.</p></li>
<li><p>Για παράδειγμα, για να εισάγουμε δύο αναρτήσεις, γράφουμε:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="op">&gt;&gt;&gt;</span> <span class="im">from</span> flaskr <span class="im">import</span> Entry</a>
<a class="sourceLine" id="cb8-2" data-line-number="2"></a>
<a class="sourceLine" id="cb8-3" data-line-number="3"><span class="op">&gt;&gt;&gt;</span> entry_1 <span class="op">=</span> Entry(title<span class="op">=</span><span class="st">&quot;First Entry&quot;</span>, text<span class="op">=</span><span class="st">&quot;This is the first entry&quot;</span>)</a>
<a class="sourceLine" id="cb8-4" data-line-number="4"><span class="op">&gt;&gt;&gt;</span> entry_2 <span class="op">=</span> Entry(title<span class="op">=</span><span class="st">&quot;Second Entry&quot;</span>, text<span class="op">=</span><span class="st">&quot;This is the second entry&quot;</span>)</a>
<a class="sourceLine" id="cb8-5" data-line-number="5"></a>
<a class="sourceLine" id="cb8-6" data-line-number="6"><span class="op">&gt;&gt;&gt;</span> db.session.add(entry_1)</a>
<a class="sourceLine" id="cb8-7" data-line-number="7"><span class="op">&gt;&gt;&gt;</span> db.session.add(entry_2)</a>
<a class="sourceLine" id="cb8-8" data-line-number="8"><span class="op">&gt;&gt;&gt;</span> db.session.commit()</a></code></pre></div></li>
</ul>
<h2 id="αναζήτηση-δεδομένων">Αναζήτηση δεδομένων</h2>
<ul>
<li><p>Για να κάνουμε μια αναζήτηση στα δεδομένα, γράφουμε:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="op">&gt;&gt;&gt;</span> entries <span class="op">=</span> Entry.query.<span class="bu">all</span>()</a></code></pre></div></li>
<li><p>Πράγματι, ενόσω είμαστε στη γραμμή εντολών μπορούμε να επιβεβαιώσουμε τις εγγραφές:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="op">&gt;&gt;&gt;</span> entries</a>
<a class="sourceLine" id="cb10-2" data-line-number="2"></a>
<a class="sourceLine" id="cb10-3" data-line-number="3">[<span class="op">&lt;</span>Entry <span class="st">'First Entry'</span> <span class="st">'This is the first entry'</span><span class="op">&gt;</span>,</a>
<a class="sourceLine" id="cb10-4" data-line-number="4"> <span class="op">&lt;</span>Entry <span class="st">'Second Entry'</span> <span class="st">'This is the second entry'</span><span class="op">&gt;</span>]</a></code></pre></div></li>
</ul>
<div class="notes">
<p>Στο συγκεκριμένο παράδειγμα αναζητούμε το σύνολο των δεδομένων. Φυσικά μπορούμε να κάνουμε πιο λεπτομερείς και περίπλοκες αναζητήσεις. Δείτε τη <a href="http://flask-sqlalchemy.pocoo.org/2.3/queries/#querying-records">σχετική τεκμηρίωση του Flask-SQLAlchemy</a> και την <a href="http://docs.sqlalchemy.org/en/latest/orm/tutorial.html#common-filter-operators">πλήρη τεκμηρίωση του SQLAlchemy</a>.</p>
</div>
<h2 id="εμφάνιση-εντολών-sql">Εμφάνιση Εντολών SQL</h2>
<ul>
<li><p>Αν θέλουμε να δούμε τις εντολές που δημιουργεί και εκτελεί το SQLAlchemy, προσθέτουμε το παρακάτω στις ρυθμίσεις αρχικοποίησης μέσα στην κλήση <code>app.config.update()</code>.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb11-1" data-line-number="1">SQLALCHEMY_ECHO <span class="op">=</span> <span class="va">True</span></a></code></pre></div></li>
</ul>
<h2 id="διαγραφή-δεδομένων">Διαγραφή δεδομένων</h2>
<ul>
<li><p>Για να σβήσουμε μια συγκεκριμένη εγγραφή, έστω την <code>entry_1</code>, δίνουμε:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb12-1" data-line-number="1"><span class="op">&gt;&gt;&gt;</span> db.session.delete(entry_1)</a>
<a class="sourceLine" id="cb12-2" data-line-number="2"><span class="op">&gt;&gt;&gt;</span> db.session.commit()</a></code></pre></div></li>
<li><p>Για να διαγράψουμε όλες τις εγγραφές ενός πίνακα δίνουμε:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb13-1" data-line-number="1"><span class="op">&gt;&gt;&gt;</span> Entry.query.delete()</a>
<a class="sourceLine" id="cb13-2" data-line-number="2"><span class="dv">1</span></a>
<a class="sourceLine" id="cb13-3" data-line-number="3"><span class="op">&gt;&gt;&gt;</span> db.session.commit()</a></code></pre></div></li>
<li><p>Επιβεβαιώνουμε:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb14-1" data-line-number="1"><span class="op">&gt;&gt;&gt;</span> entries <span class="op">=</span> Entry.query.<span class="bu">all</span>()</a>
<a class="sourceLine" id="cb14-2" data-line-number="2"><span class="op">&gt;&gt;&gt;</span> entries</a>
<a class="sourceLine" id="cb14-3" data-line-number="3">[]</a></code></pre></div></li>
</ul>
<h2 id="εμφάνιση-αναρτήσεων">Εμφάνιση αναρτήσεων</h2>
<ul>
<li><p>Θα συνεχίσουμε με τη συγγραφή των μεθόδων για το χειρισμό των λειτουργιών της υπηρεσίας.</p></li>
<li><p>Η εμφάνιση των αναρτήσεων, με τη χρήση πλέον Flask-SQLAlchemy, είναι:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb15-1" data-line-number="1"><span class="at">@app.route</span>(<span class="st">'/'</span>)</a>
<a class="sourceLine" id="cb15-2" data-line-number="2"><span class="kw">def</span> show_entries():</a>
<a class="sourceLine" id="cb15-3" data-line-number="3">    entries <span class="op">=</span> Entry.query.<span class="bu">all</span>()</a>
<a class="sourceLine" id="cb15-4" data-line-number="4">    <span class="cf">return</span> render_template(<span class="st">'show_entries.html'</span>, entries<span class="op">=</span>entries)</a></code></pre></div></li>
</ul>
<div class="notes">
<p>Η μέθοδος είναι στην ουσία η ίδια με αυτήν που είχαμε στην προηγούμενη έκδοση της εφαρμογής, αλλά αντί να γράψουμε την εντολή της αναζήτησης σε SQL γράφουμε μόνο τις αντίστοιχες εντολές σε Python.</p>
</div>
<h2 id="προσθήκη-ανάρτησης">Προσθήκη ανάρτησης</h2>
<ul>
<li><p>Αντίστοιχα, η προσθήκη αναρτήσεων γίνεται:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb16-1" data-line-number="1"><span class="at">@app.route</span>(<span class="st">'/add'</span>, methods<span class="op">=</span>[<span class="st">'POST'</span>])</a>
<a class="sourceLine" id="cb16-2" data-line-number="2"><span class="kw">def</span> add_entry():</a>
<a class="sourceLine" id="cb16-3" data-line-number="3">    <span class="cf">if</span> <span class="kw">not</span> session.get(<span class="st">'logged_in'</span>):</a>
<a class="sourceLine" id="cb16-4" data-line-number="4">        abort(<span class="dv">401</span>)</a>
<a class="sourceLine" id="cb16-5" data-line-number="5">    entry <span class="op">=</span> Entry(title<span class="op">=</span>request.form[<span class="st">'title'</span>], text<span class="op">=</span>request.form[<span class="st">'text'</span>])</a>
<a class="sourceLine" id="cb16-6" data-line-number="6">    db.session.add(entry)</a>
<a class="sourceLine" id="cb16-7" data-line-number="7">    db.session.commit()</a>
<a class="sourceLine" id="cb16-8" data-line-number="8">    flash(<span class="st">'New entry was successfully posted'</span>)</a>
<a class="sourceLine" id="cb16-9" data-line-number="9">    <span class="cf">return</span> redirect(url_for(<span class="st">'show_entries'</span>))</a></code></pre></div></li>
</ul>
<div class="notes">
<p>Και πάλι, οι αλλαγές σε σχέση με την προηγούμενη εκδοσή αφορούν στη χρήση Python αντί για τη χρήση SQL. Δημιουργούμε ένα αντικείμενο της κλάσης <code>Entry</code> χρησιμοποιώντας τα στοιχεία που έχει συμπληρώσει ο χρήστης στη φόρμα της εφαρμογής, και στη συνέχεια εισάγουμε τη νέα ανάρτηση στη βάση και επικυρώνουμε την εισαγωγή.</p>
</div>
<h2 id="λοιπές-λειτουργίες-και-εκκίνηση">Λοιπές λειτουργίες και εκκίνηση</h2>
<ul>
<li><p>Οι άλλες δύο λειτουργίες, είσοδος και έξοδος, παραμένουν ως έχουν.</p></li>
<li><p>Συνεπώς, απλώς αντιγράψτε τες από την προηγούμενη έκδοση της εφαρμογής.</p></li>
<li><p>Για να τρέξετε την εφαρμογή δίνετε ό,τι και στην προηγούμενη έκδοση.</p></li>
</ul>
<div class="notes">
<p>Υπενθυμίζουμε:</p>
<ul>
<li><p>Για να ξεκινήσουμε την εφαρμογή σε Mac και Linux πρέπει καταρχήν να δώσουμε από τη γραμμή εντολών:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb17-1" data-line-number="1"><span class="bu">export</span> <span class="va">FLASK_APP=</span>flaskr.py</a>
<a class="sourceLine" id="cb17-2" data-line-number="2"><span class="bu">export</span> <span class="va">FLASK_DEBUG=</span>1</a></code></pre></div></li>
<li><p>Στη συνέχεια για να ξεκινήσουμε την εφαρμογή θα πρέπει να βρισκόμαστε μέσα στον κατάλογο <code>flaskr</code> και να δώσουμε:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb18-1" data-line-number="1"><span class="ex">flask</span> run</a></code></pre></div></li>
<li><p>Για να ξεκινήσουμε την εφαρμογή σε MS-Windows πρέπει καταρχήν να δώσουμε από τη γραμμή εντολών:</p>
<pre><code>set FLASK_APP=flaskr.py
set FLASK_DEBUG=1</code></pre></li>
<li><p>Στη συνέχεια για να ξεκινήσουμε την εφαρμογή θα πρέπει να βρισκόμαστε μέσα στον κατάλογο <code>flaskr</code> και να δώσουμε:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb20-1" data-line-number="1"><span class="ex">python</span> -m flask run</a></code></pre></div></li>
</ul>
</div>
<h1 id="microblog-με-πολλαπλούς-χρήστες">Microblog με Πολλαπλούς Χρήστες</h1>
<h2 id="γενικά-2">Γενικά</h2>
<ul>
<li><p>Η εφαρμογή μας, μέχρι τώρα, μπορεί να λειτουργήσει μόνο ως προσωπικό blog, αφού έχει μόνο έναν χρήστη.</p></li>
<li><p>Τώρα θα την επεκτείνουμε ώστε να μπορούμε να έχουμε πολλούς χρήστες, οι οποίοι μπορούν να δημιουργούν αναρτήσεις.</p></li>
<li><p>Συνεπώς δεν θα είναι πλέον απλώς ένα blog, αλλά περισσότερο ένας διαμοιραζόμενος πίνακας ανακοινώσεων (community board).</p></li>
</ul>
<h2 id="δημιουργία-περιβάλλοντος-1">Δημιουργία περιβάλλοντος</h2>
<ul>
<li><p>Δημιουργείστε την παρακάτω δομή καταλόγων.</p>
<pre><code>/flaskr_orm_2
    /static
    /templates</code></pre></li>
</ul>
<h2 id="προοίμιο-εφαρμογής-1">Προοίμιο εφαρμογής</h2>
<ul>
<li><p>Στον κατάλογο <code>flaskr_orm_2</code> δημιουργείστε ένα αρχείο <code>flaskr.py</code>, στο οποίο θα γράφετε αυτά που ακολουθούν.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb22-1" data-line-number="1"></a>
<a class="sourceLine" id="cb22-2" data-line-number="2"><span class="im">from</span> flask <span class="im">import</span> Flask</a>
<a class="sourceLine" id="cb22-3" data-line-number="3"><span class="im">from</span> flask <span class="im">import</span> Flask, request, session, g, redirect, url_for, abort, <span class="op">\</span></a>
<a class="sourceLine" id="cb22-4" data-line-number="4">     render_template, flash</a>
<a class="sourceLine" id="cb22-5" data-line-number="5"></a>
<a class="sourceLine" id="cb22-6" data-line-number="6"><span class="im">from</span> flask_sqlalchemy <span class="im">import</span> SQLAlchemy</a>
<a class="sourceLine" id="cb22-7" data-line-number="7"></a>
<a class="sourceLine" id="cb22-8" data-line-number="8"><span class="im">from</span> datetime <span class="im">import</span> datetime</a>
<a class="sourceLine" id="cb22-9" data-line-number="9"></a>
<a class="sourceLine" id="cb22-10" data-line-number="10">app <span class="op">=</span> Flask(<span class="va">__name__</span>)</a>
<a class="sourceLine" id="cb22-11" data-line-number="11">app.config.from_object(<span class="va">__name__</span>)</a>
<a class="sourceLine" id="cb22-12" data-line-number="12"></a>
<a class="sourceLine" id="cb22-13" data-line-number="13">app.config.update(<span class="bu">dict</span>(</a>
<a class="sourceLine" id="cb22-14" data-line-number="14">    SECRET_KEY<span class="op">=</span><span class="st">'development key'</span>,</a>
<a class="sourceLine" id="cb22-15" data-line-number="15">    SQLALCHEMY_DATABASE_URI <span class="op">=</span> <span class="st">'sqlite:///flaskr.db'</span>,</a>
<a class="sourceLine" id="cb22-16" data-line-number="16">    SQLALCHEMY_TRACK_MODIFICATIONS <span class="op">=</span> <span class="va">False</span></a>
<a class="sourceLine" id="cb22-17" data-line-number="17">))</a>
<a class="sourceLine" id="cb22-18" data-line-number="18"></a>
<a class="sourceLine" id="cb22-19" data-line-number="19">app.config.from_envvar(<span class="st">'FLASKR_SETTINGS'</span>, silent<span class="op">=</span><span class="va">True</span>)</a>
<a class="sourceLine" id="cb22-20" data-line-number="20"></a>
<a class="sourceLine" id="cb22-21" data-line-number="21">db <span class="op">=</span> SQLAlchemy(app)</a></code></pre></div></li>
</ul>
<div class="notes">
<p>Αφού θα έχουμε πολλούς χρήστες, δεν μπορούμε πλέον να αποθηκεύουμε τα στοιχεία τους στις ρυθμίσεις της εφαρμογής (που ούτως ή άλλως δεν είναι καλή ιδέα). Συνεπώς, αφαιρέσαμε τις σχετικές γραμμές. Επίσης θα χρησιμοποιήσουμε τη βιβλιοθήκη <code>datetime</code> για να αποθηκεύουμε τη χρονική στιγμή δημιουργίας κάθε ανάρτησης.</p>
</div>
<h2 id="μοντέλο-βάσης-αναρτήσεις">Μοντέλο βάσης: αναρτήσεις</h2>
<ul>
<li><p>Τώρα θα επεκτείνουμε το μοντέλο της βάσης μας ώστε να έχουμε πολλούς χρήστες.</p></li>
<li><p>Ο χρήστης θα μπορεί να δημιουργεί αναρτήσεις.</p></li>
<li><p>Κάθε ανάρτηση θα ανήκει σε έναν χρήστη.</p></li>
<li><p>Το μοντέλο των αναρτήσεων θα είναι το ακόλουθο.</p></li>
</ul>
<h2 id="κώδικας-αναρτήσεων">Κώδικας αναρτήσεων</h2>
<div class="sourceCode" id="cb23"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb23-1" data-line-number="1"><span class="kw">class</span> Entry(db.Model):</a>
<a class="sourceLine" id="cb23-2" data-line-number="2">    __tablename__ <span class="op">=</span> <span class="st">'entries'</span></a>
<a class="sourceLine" id="cb23-3" data-line-number="3">    <span class="bu">id</span> <span class="op">=</span> db.Column(db.Integer, primary_key<span class="op">=</span><span class="va">True</span>)</a>
<a class="sourceLine" id="cb23-4" data-line-number="4">    title <span class="op">=</span> db.Column(db.String(<span class="dv">120</span>), nullable<span class="op">=</span><span class="va">False</span>)</a>
<a class="sourceLine" id="cb23-5" data-line-number="5">    text <span class="op">=</span> db.Column(db.Text(), nullable<span class="op">=</span><span class="va">False</span>)</a>
<a class="sourceLine" id="cb23-6" data-line-number="6">    datetime <span class="op">=</span> db.Column(db.DateTime(), nullable<span class="op">=</span><span class="va">False</span>)</a>
<a class="sourceLine" id="cb23-7" data-line-number="7"></a>
<a class="sourceLine" id="cb23-8" data-line-number="8">    user_id <span class="op">=</span> db.Column(db.Integer, db.ForeignKey(<span class="st">'users.id'</span>))</a>
<a class="sourceLine" id="cb23-9" data-line-number="9"></a>
<a class="sourceLine" id="cb23-10" data-line-number="10">    <span class="kw">def</span> <span class="fu">__repr__</span>(<span class="va">self</span>):</a>
<a class="sourceLine" id="cb23-11" data-line-number="11">        <span class="cf">return</span> <span class="st">'&lt;Entry </span><span class="sc">%r</span><span class="st"> </span><span class="sc">%r</span><span class="st"> </span><span class="sc">%r</span><span class="st"> </span><span class="sc">%r</span><span class="st">&gt;'</span> <span class="op">%</span> (<span class="va">self</span>.title, <span class="va">self</span>.text,</a>
<a class="sourceLine" id="cb23-12" data-line-number="12">                                        <span class="va">self</span>.user_id, <span class="va">self</span>.datetime)</a></code></pre></div>
<div class="notes">
<p>Εμπλουτίζομουμε την κλάση <code>Entry</code> με δύο επιπλέον πεδία:</p>
<ul>
<li><p><code>datetime</code>, όπου θα αποθηκεύεται η χρονική στιγμή δημιουργίας της ανάρτησης.</p></li>
<li><p><code>user_id</code>, όπου θα αποθηκεύεται ο κωδικός στη βάση του χρήστη που έκανε την ανάρτηση. Αυτό θα είναι ένα ξένο κλειδί (foreign key) στον πίνακα <code>users</code>, όπου θα αποθηκεύουμε τους χρήστες, όπως θα δούμε στη συνέχεια.</p></li>
</ul>
</div>
<h2 id="μοντέλο-βάσης-χρήστες">Μοντέλο βάσης: χρήστες</h2>
<ul>
<li><p>Ο κάθε χρήστης θα έχει όνομα, επώνυμο, κωδικό, e-mail.</p></li>
<li><p>Επίσης κάθε χρήστης έχει ένα σύνολο αναρτήσεων που έχει δημιουργήσει.</p></li>
</ul>
<h2 id="κώδικας-χρηστών">Κώδικας χρηστών</h2>
<div class="sourceCode" id="cb24"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb24-1" data-line-number="1"><span class="kw">class</span> User(db.Model):</a>
<a class="sourceLine" id="cb24-2" data-line-number="2">    __tablename__ <span class="op">=</span> <span class="st">'users'</span></a>
<a class="sourceLine" id="cb24-3" data-line-number="3">    <span class="bu">id</span> <span class="op">=</span> db.Column(db.Integer, primary_key<span class="op">=</span><span class="va">True</span>)</a>
<a class="sourceLine" id="cb24-4" data-line-number="4">    username <span class="op">=</span> db.Column(db.String(<span class="dv">20</span>),</a>
<a class="sourceLine" id="cb24-5" data-line-number="5">                         nullable<span class="op">=</span><span class="va">False</span>,</a>
<a class="sourceLine" id="cb24-6" data-line-number="6">                         unique<span class="op">=</span><span class="va">True</span>,</a>
<a class="sourceLine" id="cb24-7" data-line-number="7">                         index<span class="op">=</span><span class="va">True</span>)</a>
<a class="sourceLine" id="cb24-8" data-line-number="8">    password <span class="op">=</span> db.Column(db.String(<span class="dv">30</span>), nullable<span class="op">=</span><span class="va">False</span>)</a>
<a class="sourceLine" id="cb24-9" data-line-number="9">    name <span class="op">=</span> db.Column(db.String(<span class="dv">20</span>), nullable<span class="op">=</span><span class="va">False</span>)</a>
<a class="sourceLine" id="cb24-10" data-line-number="10">    surname <span class="op">=</span> db.Column(db.String(<span class="dv">30</span>), nullable<span class="op">=</span><span class="va">False</span>)</a>
<a class="sourceLine" id="cb24-11" data-line-number="11">    email <span class="op">=</span> db.Column(db.String(<span class="dv">30</span>), nullable<span class="op">=</span><span class="va">False</span>)</a>
<a class="sourceLine" id="cb24-12" data-line-number="12">    entries <span class="op">=</span> db.relationship(<span class="st">'Entry'</span>, backref<span class="op">=</span><span class="st">'user'</span>, lazy<span class="op">=</span><span class="va">True</span>)</a>
<a class="sourceLine" id="cb24-13" data-line-number="13"></a>
<a class="sourceLine" id="cb24-14" data-line-number="14">    <span class="kw">def</span> <span class="fu">__repr__</span>(<span class="va">self</span>):</a>
<a class="sourceLine" id="cb24-15" data-line-number="15">        <span class="cf">return</span> <span class="st">'&lt;User </span><span class="sc">%r</span><span class="st"> </span><span class="sc">%r</span><span class="st"> </span><span class="sc">%r</span><span class="st"> </span><span class="sc">%r</span><span class="st">&gt;'</span> <span class="op">%</span> (<span class="va">self</span>.username, <span class="va">self</span>.email,</a>
<a class="sourceLine" id="cb24-16" data-line-number="16">                                       <span class="va">self</span>.name, <span class="va">self</span>.surname)</a></code></pre></div>
<div class="notes">
<p>Ορίζουμε τα πεδία του χρήστη με τους περιορισμούς που τους αρμόζουν: για παράδειγμα, το <code>username</code> θέλουμε να μην είναι null, να είναι μοναδικό, και να δημιουργηθεί ένα ευρετήριο (index) επάνω του.</p>
<p>Το πεδίο <code>entries</code> είναι αυτό που θα περιέχει το σύνολο των αναρτήσεων που έχει κάνει ένας χρήστης. Ορίζουμε λοιπόν ότι αντιστοιχεί σε μία σχέση, και όχι σε μία στήλη. Στη σχέση δίνουμε το όνομα της κλάσης στην οποία θα δείχνει. Επιπλέον, με την παράμετρο <code>backref='user'</code> ορίζουμε ότι στην κλάση <code>Entry</code> θα δημιουργηθεί δυναμικά ένα πεδίο <code>user</code> το οποίο θα δείχνει στον χρήστη που έκανε τη συγκεκριμένη ανάρτηση. Η παράμετρος <code>lazy=True</code> ορίζει ότι οι αναρτήσεις για έναν χρήστη θα διαβάζονται από τη βάση μόνο όταν ζητηθούν, και όχι απλώς όταν διαβάζουμε έναν χρήστη. Ο τρόπος με τον οποίο διαβάζονται από τη βάση τα αντικείμενα μιας σχέσης μπορεί να είναι σημαντικός παράγοντας βελτιστοποίησης. Για περισσότερες πληροφορίες, βλ. τη σχετική τεκμηρίωση του <a href="http://flask-sqlalchemy.pocoo.org/2.3/models/#one-to-many-relationships">Flask-SQLAlchemy</a> και του <a href="http://docs.sqlalchemy.org/en/latest/orm/tutorial.html#building-a-relationship">SQLAlchemy</a>.</p>
</div>
<h2 id="δημιουργία-βάσης-1">Δημιουργία βάσης</h2>
<ul>
<li><p>Για να δημιουργήσουμε τη βάση θα χρησιμοποιήσουμε και πάλι τη γραμμή εντολών της Python ή IPython:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb25-1" data-line-number="1"><span class="op">&gt;&gt;&gt;</span> <span class="im">from</span> flaskr <span class="im">import</span> <span class="op">*</span></a>
<a class="sourceLine" id="cb25-2" data-line-number="2"><span class="op">&gt;&gt;&gt;</span> db.create_all()</a></code></pre></div></li>
</ul>
<h2 id="εισαγωγή-χρηστών">Εισαγωγή χρηστών</h2>
<ul>
<li><p>Αυτή τη στιγμή δεν θα υλοποιήσουμε τη διαδικασία εγγραφής χρηστών μέσα στην εφαρμογή, οπότε απλώς θα τους εισάγουμε απ’ ευθείας μέσω της γραμμής εντολών Python:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb26-1" data-line-number="1"></a>
<a class="sourceLine" id="cb26-2" data-line-number="2"><span class="op">&gt;&gt;&gt;</span> user_1 <span class="op">=</span> User(username<span class="op">=</span><span class="st">&quot;louridas&quot;</span>,</a>
<a class="sourceLine" id="cb26-3" data-line-number="3">    name<span class="op">=</span><span class="st">&quot;Panos&quot;</span>,</a>
<a class="sourceLine" id="cb26-4" data-line-number="4">    surname<span class="op">=</span><span class="st">&quot;Louridas&quot;</span>,</a>
<a class="sourceLine" id="cb26-5" data-line-number="5">    email<span class="op">=</span><span class="st">&quot;louridas@aueb.gr&quot;</span>,</a>
<a class="sourceLine" id="cb26-6" data-line-number="6">    password<span class="op">=</span><span class="st">&quot;12345&quot;</span>)</a>
<a class="sourceLine" id="cb26-7" data-line-number="7"></a>
<a class="sourceLine" id="cb26-8" data-line-number="8"><span class="op">&gt;&gt;&gt;</span> user_2 <span class="op">=</span> User(username<span class="op">=</span><span class="st">&quot;johndoe&quot;</span>, </a>
<a class="sourceLine" id="cb26-9" data-line-number="9">    name<span class="op">=</span><span class="st">&quot;John&quot;</span>, </a>
<a class="sourceLine" id="cb26-10" data-line-number="10">    surname<span class="op">=</span><span class="st">&quot;Doe&quot;</span>, </a>
<a class="sourceLine" id="cb26-11" data-line-number="11">    email<span class="op">=</span><span class="st">&quot;johndoe@gmail.com&quot;</span>, </a>
<a class="sourceLine" id="cb26-12" data-line-number="12">    password<span class="op">=</span><span class="st">&quot;54321&quot;</span>)</a>
<a class="sourceLine" id="cb26-13" data-line-number="13"></a>
<a class="sourceLine" id="cb26-14" data-line-number="14"><span class="op">&gt;&gt;&gt;</span> db.session.add(user_1)</a>
<a class="sourceLine" id="cb26-15" data-line-number="15"><span class="op">&gt;&gt;&gt;</span> db.session.add(user_2)</a>
<a class="sourceLine" id="cb26-16" data-line-number="16"><span class="op">&gt;&gt;&gt;</span> db.session.commit()</a></code></pre></div></li>
</ul>
<div class="notes">
<p>Προφανώς τέτοιοι κωδικοί είναι εντελώς απαράδεκτοι.</p>
</div>
<h2 id="εμφάνιση-αναρτήσεων-1">Εμφάνιση αναρτήσεων</h2>
<ul>
<li><p>Για να δούμε τις αναρτήσεις θα κάνουμε αναζήτηση στη βάση μέσω SQLAlchemy:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb27-1" data-line-number="1"><span class="at">@app.route</span>(<span class="st">'/'</span>)</a>
<a class="sourceLine" id="cb27-2" data-line-number="2"><span class="kw">def</span> show_entries():</a>
<a class="sourceLine" id="cb27-3" data-line-number="3">    entries <span class="op">=</span> Entry.query.order_by(Entry.datetime.desc()).<span class="bu">all</span>()</a>
<a class="sourceLine" id="cb27-4" data-line-number="4">    <span class="cf">return</span> render_template(<span class="st">'show_entries.html'</span>, entries<span class="op">=</span>entries)</a></code></pre></div></li>
</ul>
<div class="notes">
<p>Εδώ βλέπετε ένα επιπλέον χαρακτηριστικό των αναζητήσεων: μπορείτε να ορίσετε διαφόρους τρόπους ταξινόμησης των αποτελεσμάτων. Όπως πάντα, περισσότερες πληροφορίες θα βρείτε στην τεκμηρίωση του <a href="http://flask-sqlalchemy.pocoo.org/2.3/queries/#querying-records">Flask-SQLAlchemy</a> και του <a href="http://docs.sqlalchemy.org/en/latest/orm/tutorial.html#querying">SQLAlchemy</a>.</p>
</div>
<h2 id="προσθήκη-ανάρτησης-1">Προσθήκη ανάρτησης</h2>
<ul>
<li><p>Όταν ο χρήστης δημιουργεί μια νέα ανάρτηση θα πρέπει να αποθηκεύουμε στη βάση: * τον τίτλο * το κείμενό της * ποιος χρήστης έκανε την ανάρτηση * ποια ακριβώς χρονική στιγμή</p></li>
<li><p>Η εισαγωγή θα γίνει μέσω SQLAlchemy.</p></li>
</ul>
<h2 id="κώδικας-προσθήκης">Κώδικας προσθήκης</h2>
<div class="sourceCode" id="cb28"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb28-1" data-line-number="1"><span class="at">@app.route</span>(<span class="st">'/add'</span>, methods<span class="op">=</span>[<span class="st">'POST'</span>])</a>
<a class="sourceLine" id="cb28-2" data-line-number="2"><span class="kw">def</span> add_entry():</a>
<a class="sourceLine" id="cb28-3" data-line-number="3">    user_id <span class="op">=</span> session.get(<span class="st">'user_id'</span>)</a>
<a class="sourceLine" id="cb28-4" data-line-number="4">    <span class="cf">if</span> user_id <span class="kw">is</span> <span class="va">None</span>:</a>
<a class="sourceLine" id="cb28-5" data-line-number="5">        abort(<span class="dv">401</span>)</a>
<a class="sourceLine" id="cb28-6" data-line-number="6">    entry <span class="op">=</span> Entry(title<span class="op">=</span>request.form[<span class="st">'title'</span>],</a>
<a class="sourceLine" id="cb28-7" data-line-number="7">                  text<span class="op">=</span>request.form[<span class="st">'text'</span>],</a>
<a class="sourceLine" id="cb28-8" data-line-number="8">                  user_id<span class="op">=</span>user_id,</a>
<a class="sourceLine" id="cb28-9" data-line-number="9">                  datetime<span class="op">=</span>datetime.now())</a>
<a class="sourceLine" id="cb28-10" data-line-number="10"></a>
<a class="sourceLine" id="cb28-11" data-line-number="11">    db.session.add(entry)</a>
<a class="sourceLine" id="cb28-12" data-line-number="12">    db.session.commit()</a>
<a class="sourceLine" id="cb28-13" data-line-number="13">    flash(<span class="st">'New entry was successfully posted'</span>)</a>
<a class="sourceLine" id="cb28-14" data-line-number="14">    <span class="cf">return</span> redirect(url_for(<span class="st">'show_entries'</span>))</a></code></pre></div>
<div class="notes">
<p>Δημιουργούμε ένα αντικείμενο της κλάσης <code>Entry</code> με τα δεδομένα που έχει εισάγει ο χρήστης από τη σχετική φόρμα. Η κλήση <code>datetime.now()</code> δίνει την τρέχουσα χρονική στιγμή.</p>
<p>Προσέξτε τον έλεγχο για το αν ο χρήστης έχει περάσει τη διαδικασία εισόδου στο σύστημα. Στις προηγούμενες εκδόσεις της εφαρμογής ελέγχαμε απλώς αν το αντικείμενο <code>session</code> είχε ένα κλειδί <code>logged_in</code>. Τώρα ελέγχουμε αν υπάρχει μέσα σε αυτό το <code>user_id</code>. Θα δούμε παρακάτω ότι το εισάγουμε κατά τη διαδικασία εισόδου στο σύστημα.</p>
</div>
<h2 id="είσοδος">Είσοδος</h2>
<div class="sourceCode" id="cb29"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb29-1" data-line-number="1"><span class="at">@app.route</span>(<span class="st">'/login'</span>, methods<span class="op">=</span>[<span class="st">'GET'</span>, <span class="st">'POST'</span>])</a>
<a class="sourceLine" id="cb29-2" data-line-number="2"><span class="kw">def</span> login():</a>
<a class="sourceLine" id="cb29-3" data-line-number="3">    error <span class="op">=</span> <span class="va">None</span></a>
<a class="sourceLine" id="cb29-4" data-line-number="4">    <span class="cf">if</span> request.method <span class="op">==</span> <span class="st">'POST'</span>:</a>
<a class="sourceLine" id="cb29-5" data-line-number="5">        user <span class="op">=</span> User.query.filter_by(</a>
<a class="sourceLine" id="cb29-6" data-line-number="6">            username<span class="op">=</span>request.form[<span class="st">'username'</span>]).one_or_none():</a>
<a class="sourceLine" id="cb29-7" data-line-number="7">        <span class="cf">if</span> user <span class="kw">is</span> <span class="va">None</span>:</a>
<a class="sourceLine" id="cb29-8" data-line-number="8">            error <span class="op">=</span> <span class="st">'Invalid username'</span></a>
<a class="sourceLine" id="cb29-9" data-line-number="9">        <span class="cf">elif</span> request.form[<span class="st">'password'</span>] <span class="op">!=</span> user.password:</a>
<a class="sourceLine" id="cb29-10" data-line-number="10">            error <span class="op">=</span> <span class="st">'Invalid password'</span></a>
<a class="sourceLine" id="cb29-11" data-line-number="11">        <span class="cf">else</span>:</a>
<a class="sourceLine" id="cb29-12" data-line-number="12">            session[<span class="st">'user_id'</span>] <span class="op">=</span> user.<span class="bu">id</span></a>
<a class="sourceLine" id="cb29-13" data-line-number="13">            session[<span class="st">'username'</span>] <span class="op">=</span> user.username</a>
<a class="sourceLine" id="cb29-14" data-line-number="14">            flash(<span class="st">'You were logged in'</span>)</a>
<a class="sourceLine" id="cb29-15" data-line-number="15">            <span class="cf">return</span> redirect(url_for(<span class="st">'show_entries'</span>))</a>
<a class="sourceLine" id="cb29-16" data-line-number="16">    <span class="cf">return</span> render_template(<span class="st">'login.html'</span>, error<span class="op">=</span>error)</a></code></pre></div>
<div class="notes">
<p>Για να διαπιστώσουμε αν ένας χρήστης έχει δικαίωμα εισόδου στην εφαρμογή, πραγματοποιούμε αναζήτηση στη βάση με βάση το <code>username</code> που μας έχει δώσει. Οι αναζητήσεις στη βάση επιστρέφουν εν δυνάμει πολλά αποτελέσματα, οπότε εμείς ζητούμε απλώς το πρώτο (και μοναδικό). Αν δεν υπάρχει, επιστρέφουμε μήνυμα λάθους. Διαφορετικά, αν υπάρχει, ελέγχουμε αν ο κωδικός που έχει δώσει ο χρήστης συμφωνεί με τον κωδικό που έχει αποθηκευτεί στη βάση, και οποίος βρίσκεται πλέον στο πεδίο <code>user.password</code>.</p>
<p>Αν όλα πάνε καλά, εισάγουμε στο αντικείμενο <code>session</code> το <code>id</code> και το <code>username</code> του χρήστη.</p>
</div>
<h2 id="έξοδος">Έξοδος</h2>
<div class="sourceCode" id="cb30"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb30-1" data-line-number="1"><span class="at">@app.route</span>(<span class="st">'/logout'</span>)</a>
<a class="sourceLine" id="cb30-2" data-line-number="2"><span class="kw">def</span> logout():</a>
<a class="sourceLine" id="cb30-3" data-line-number="3">    session.pop(<span class="st">'user_id'</span>, <span class="va">None</span>)</a>
<a class="sourceLine" id="cb30-4" data-line-number="4">    session.pop(<span class="st">'username'</span>, <span class="va">None</span>)</a>
<a class="sourceLine" id="cb30-5" data-line-number="5">    flash(<span class="st">'You were logged out'</span>)</a>
<a class="sourceLine" id="cb30-6" data-line-number="6">    <span class="cf">return</span> redirect(url_for(<span class="st">'show_entries'</span>))</a></code></pre></div>
<div class="notes">
<p>Για την έξοδο, αντιστρόφως από την είσοδο, αφαιρούμε από το αντικείμενο <code>session</code> το <code>id</code> και το <code>username</code> του χρήστη.</p>
</div>
<h2 id="βασικό-πρότυπο-εμφάνισης">Βασικό πρότυπο εμφάνισης</h2>
<ul>
<li><p>Το βασικό πρότυπο των σελίδων μας θα δίνεται και πάλι από τη σελίδα <code>layout.html</code> στον κατάλογο <code>static</code>.</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode html"><code class="sourceCode html"><a class="sourceLine" id="cb31-1" data-line-number="1"><span class="dt">&lt;!doctype </span>html<span class="dt">&gt;</span></a>
<a class="sourceLine" id="cb31-2" data-line-number="2"><span class="kw">&lt;title&gt;</span>Flaskr<span class="kw">&lt;/title&gt;</span></a>
<a class="sourceLine" id="cb31-3" data-line-number="3"><span class="kw">&lt;link</span><span class="ot"> rel=</span><span class="st">stylesheet</span><span class="ot"> type=</span><span class="st">text/css</span></a>
<a class="sourceLine" id="cb31-4" data-line-number="4"><span class="ot">      href=</span><span class="st">&quot;{{ url_for('static', filename='style.css') }}&quot;</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb31-5" data-line-number="5"><span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">page</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb31-6" data-line-number="6">  <span class="kw">&lt;h1&gt;</span>Flaskr<span class="kw">&lt;/h1&gt;</span></a>
<a class="sourceLine" id="cb31-7" data-line-number="7">  <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">metanav</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb31-8" data-line-number="8">  {% if not session.user_id %}</a>
<a class="sourceLine" id="cb31-9" data-line-number="9">    <span class="kw">&lt;a</span><span class="ot"> href=</span><span class="st">&quot;{{ url_for('login') }}&quot;</span><span class="kw">&gt;</span>log in<span class="kw">&lt;/a&gt;</span></a>
<a class="sourceLine" id="cb31-10" data-line-number="10">  {% else %}</a>
<a class="sourceLine" id="cb31-11" data-line-number="11">    <span class="kw">&lt;a</span><span class="ot"> href=</span><span class="st">&quot;{{ url_for('logout') }}&quot;</span><span class="kw">&gt;</span>log out<span class="kw">&lt;/a&gt;</span></a>
<a class="sourceLine" id="cb31-12" data-line-number="12">  {% endif %}</a>
<a class="sourceLine" id="cb31-13" data-line-number="13">  <span class="kw">&lt;/div&gt;</span></a>
<a class="sourceLine" id="cb31-14" data-line-number="14">  {% for message in get_flashed_messages() %}</a>
<a class="sourceLine" id="cb31-15" data-line-number="15">    <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">flash</span><span class="kw">&gt;</span>{{ message }}<span class="kw">&lt;/div&gt;</span></a>
<a class="sourceLine" id="cb31-16" data-line-number="16">  {% endfor %}</a>
<a class="sourceLine" id="cb31-17" data-line-number="17">  {% block body %}{% endblock %}</a>
<a class="sourceLine" id="cb31-18" data-line-number="18"><span class="kw">&lt;/div&gt;</span></a></code></pre></div></li>
</ul>
<div class="notes">
<p>Ο έλεγχος για τον χρήστη πραγματοποιείται πλέον με το πεδίο <code>user_id</code> του αντικειμένου <code>session</code>, αντί για το <code>logged_in</code> της προηγούμενης έκδοσης.</p>
</div>
<h2 id="εμφάνιση-αναρτήσεων-2">Εμφάνιση αναρτήσεων</h2>
<ul>
<li><p>Η σελίδα εμφάνισης αναρτήσεων επεκτείνει το βασικό πρότυπο.</p></li>
<li><p>Δημιουργούμε το ακόλουθο αρχείο <code>show_entries.html</code> στον κατάλογο <code>static</code>.</p></li>
</ul>
<h2 id="κώδικας-εμφάνισης">Κώδικας εμφάνισης</h2>
<div class="sourceCode" id="cb32"><pre class="sourceCode html"><code class="sourceCode html"><a class="sourceLine" id="cb32-1" data-line-number="1">{% extends &quot;layout.html&quot; %}</a>
<a class="sourceLine" id="cb32-2" data-line-number="2">{% block body %}</a>
<a class="sourceLine" id="cb32-3" data-line-number="3">  {% if session.user_id %}</a>
<a class="sourceLine" id="cb32-4" data-line-number="4">    <span class="kw">&lt;form</span><span class="ot"> action=</span><span class="st">&quot;{{ url_for('add_entry') }}&quot;</span><span class="ot"> method=</span><span class="st">post</span><span class="ot"> class=</span><span class="st">add-entry</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb32-5" data-line-number="5">      <span class="kw">&lt;dl&gt;</span></a>
<a class="sourceLine" id="cb32-6" data-line-number="6">        <span class="kw">&lt;dt&gt;</span>Title:</a>
<a class="sourceLine" id="cb32-7" data-line-number="7">        <span class="kw">&lt;dd&gt;&lt;input</span><span class="ot"> type=</span><span class="st">text</span><span class="ot"> size=</span><span class="st">30</span><span class="ot"> name=</span><span class="st">title</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb32-8" data-line-number="8">        <span class="kw">&lt;dt&gt;</span>Text:</a>
<a class="sourceLine" id="cb32-9" data-line-number="9">        <span class="kw">&lt;dd&gt;&lt;textarea</span><span class="ot"> name=</span><span class="st">text</span><span class="ot"> rows=</span><span class="st">5</span><span class="ot"> cols=</span><span class="st">40</span><span class="kw">&gt;&lt;/textarea&gt;</span></a>
<a class="sourceLine" id="cb32-10" data-line-number="10">        <span class="kw">&lt;dd&gt;&lt;input</span><span class="ot"> type=</span><span class="st">submit</span><span class="ot"> value=</span><span class="st">Share</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb32-11" data-line-number="11">      <span class="kw">&lt;/dl&gt;</span></a>
<a class="sourceLine" id="cb32-12" data-line-number="12">    <span class="kw">&lt;/form&gt;</span></a>
<a class="sourceLine" id="cb32-13" data-line-number="13">  {% endif %}</a>
<a class="sourceLine" id="cb32-14" data-line-number="14">  <span class="kw">&lt;ul</span><span class="ot"> class=</span><span class="st">entries</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb32-15" data-line-number="15">  {% for entry in entries %}</a>
<a class="sourceLine" id="cb32-16" data-line-number="16">    <span class="kw">&lt;li&gt;&lt;h2&gt;</span>{{ entry.title }}<span class="kw">&lt;/h2&gt;</span></a>
<a class="sourceLine" id="cb32-17" data-line-number="17">      {{ entry.user.username }} {{ entry.datetime }}</a>
<a class="sourceLine" id="cb32-18" data-line-number="18">      <span class="kw">&lt;p&gt;</span></a>
<a class="sourceLine" id="cb32-19" data-line-number="19">      {{ entry.text|safe }}</a>
<a class="sourceLine" id="cb32-20" data-line-number="20">      <span class="kw">&lt;/p&gt;</span></a>
<a class="sourceLine" id="cb32-21" data-line-number="21">  {% else %}</a>
<a class="sourceLine" id="cb32-22" data-line-number="22">    <span class="kw">&lt;li&gt;&lt;em&gt;</span>Unbelievable.  No entries here so far<span class="kw">&lt;/em&gt;</span></a>
<a class="sourceLine" id="cb32-23" data-line-number="23">  {% endfor %}</a>
<a class="sourceLine" id="cb32-24" data-line-number="24">  <span class="kw">&lt;/ul&gt;</span></a>
<a class="sourceLine" id="cb32-25" data-line-number="25">{% endblock %}</a></code></pre></div>
<div class="notes">
<p>Στη νέα έκδοση εμφανίζουμε, εκτός από τον τίτλο και το περιεχόμενο κάθε ανάρτησης, το όνομα του χρήστη και τη χρονική στιγμή που έγινε η ανάρτηση.</p>
</div>
<h2 id="είσοδος-1">Είσοδος</h2>
<ul>
<li><p>Η σελίδα εμφάνισης αναρτήσεων επεκτείνει επίσης το βασικό πρότυπο.</p></li>
<li><p>Δημιουργούμε το ακόλουθο αρχείο <code>login.html</code> στον κατάλογο <code>static</code>.</p></li>
</ul>
<h2 id="κώδικας-εισόδου">Κώδικας εισόδου</h2>
<div class="sourceCode" id="cb33"><pre class="sourceCode html"><code class="sourceCode html"><a class="sourceLine" id="cb33-1" data-line-number="1">{% extends &quot;layout.html&quot; %}</a>
<a class="sourceLine" id="cb33-2" data-line-number="2">{% block body %}</a>
<a class="sourceLine" id="cb33-3" data-line-number="3">  <span class="kw">&lt;h2&gt;</span>Login<span class="kw">&lt;/h2&gt;</span></a>
<a class="sourceLine" id="cb33-4" data-line-number="4">  {% if error %}</a>
<a class="sourceLine" id="cb33-5" data-line-number="5">    <span class="kw">&lt;p</span><span class="ot"> class=</span><span class="st">error</span><span class="kw">&gt;&lt;strong&gt;</span>Error:<span class="kw">&lt;/strong&gt;</span> {{ error }}</a>
<a class="sourceLine" id="cb33-6" data-line-number="6">  {% endif %}</a>
<a class="sourceLine" id="cb33-7" data-line-number="7">  <span class="kw">&lt;form</span><span class="ot"> action=</span><span class="st">&quot;{{ url_for('login') }}&quot;</span><span class="ot"> method=</span><span class="st">post</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb33-8" data-line-number="8">    <span class="kw">&lt;dl&gt;</span></a>
<a class="sourceLine" id="cb33-9" data-line-number="9">      <span class="kw">&lt;dt&gt;</span>Username:</a>
<a class="sourceLine" id="cb33-10" data-line-number="10">      <span class="kw">&lt;dd&gt;&lt;input</span><span class="ot"> type=</span><span class="st">text</span><span class="ot"> name=</span><span class="st">username</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb33-11" data-line-number="11">      <span class="kw">&lt;dt&gt;</span>Password:</a>
<a class="sourceLine" id="cb33-12" data-line-number="12">      <span class="kw">&lt;dd&gt;&lt;input</span><span class="ot"> type=</span><span class="st">password</span><span class="ot"> name=</span><span class="st">password</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb33-13" data-line-number="13">      <span class="kw">&lt;dd&gt;&lt;input</span><span class="ot"> type=</span><span class="st">submit</span><span class="ot"> value=</span><span class="st">Login</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb33-14" data-line-number="14">    <span class="kw">&lt;/dl&gt;</span></a>
<a class="sourceLine" id="cb33-15" data-line-number="15">  <span class="kw">&lt;/form&gt;</span></a>
<a class="sourceLine" id="cb33-16" data-line-number="16">{% endblock %}</a></code></pre></div>
<div class="notes">
<p>Αντίστοιχα, η σελίδα <code>login.html</code> επεκτείνει τη <code>layout.html</code>, εισάγοντας σε αυτήν τη φόρμα της εισαγωγής του ονόματος και του κωδικού του χρήστη.</p>
</div>
<h2 id="στυλ">Στυλ</h2>
<ul>
<li><p>Για να δώσουμε στυλ στην εφαρμογή μας, δημιουργούμε το αρχείο <code>style.css</code> στον κατάλογο <code>static</code>:</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode css"><code class="sourceCode css"><a class="sourceLine" id="cb34-1" data-line-number="1">body            { <span class="kw">font-family</span>: <span class="dv">sans-serif</span>; <span class="kw">background</span>: <span class="dv">#eee</span>; }</a>
<a class="sourceLine" id="cb34-2" data-line-number="2">a, h1, h2       { <span class="kw">color</span>: <span class="dv">#377ba8</span>; }</a>
<a class="sourceLine" id="cb34-3" data-line-number="3">h1, h2          { <span class="kw">font-family</span>: <span class="st">'Georgia'</span>, <span class="dv">serif</span>; <span class="kw">margin</span>: <span class="dv">0</span>; }</a>
<a class="sourceLine" id="cb34-4" data-line-number="4">h1              { <span class="kw">border-bottom</span>: <span class="dv">2px</span> <span class="dv">solid</span> <span class="dv">#eee</span>; }</a>
<a class="sourceLine" id="cb34-5" data-line-number="5">h2              { <span class="kw">font-size</span>: <span class="dv">1.2em</span>; }</a>
<a class="sourceLine" id="cb34-6" data-line-number="6"></a>
<a class="sourceLine" id="cb34-7" data-line-number="7"><span class="fu">.page</span>           { <span class="kw">margin</span>: <span class="dv">2em</span> <span class="dv">auto</span>; <span class="kw">width</span>: <span class="dv">35em</span>; <span class="kw">border</span>: <span class="dv">5px</span> <span class="dv">solid</span> <span class="dv">#ccc</span>;</a>
<a class="sourceLine" id="cb34-8" data-line-number="8"><span class="kw">padding</span>: <span class="dv">0.8em</span>; <span class="kw">background</span>: <span class="dv">white</span>; }</a>
<a class="sourceLine" id="cb34-9" data-line-number="9"><span class="fu">.entries</span>        { <span class="kw">list-style</span>: <span class="dv">none</span>; <span class="kw">margin</span>: <span class="dv">0</span>; <span class="kw">padding</span>: <span class="dv">0</span>; }</a>
<a class="sourceLine" id="cb34-10" data-line-number="10"><span class="fu">.entries</span> li     { <span class="kw">margin</span>: <span class="dv">0.8em</span> <span class="dv">1.2em</span>; }</a>
<a class="sourceLine" id="cb34-11" data-line-number="11"><span class="fu">.entries</span> li h2  { <span class="kw">margin-left</span>: <span class="dv">-1em</span>; }</a>
<a class="sourceLine" id="cb34-12" data-line-number="12"><span class="fu">.add-entry</span>      { <span class="kw">font-size</span>: <span class="dv">0.9em</span>; <span class="kw">border-bottom</span>: <span class="dv">1px</span> <span class="dv">solid</span> <span class="dv">#ccc</span>; }</a>
<a class="sourceLine" id="cb34-13" data-line-number="13"><span class="fu">.add-entry</span> dl   { <span class="kw">font-weight</span>: <span class="dv">bold</span>; }</a>
<a class="sourceLine" id="cb34-14" data-line-number="14"><span class="fu">.metanav</span>        { <span class="kw">text-align</span>: <span class="dv">right</span>; <span class="kw">font-size</span>: <span class="dv">0.8em</span>; <span class="kw">padding</span>: <span class="dv">0.3em</span>;</a>
<a class="sourceLine" id="cb34-15" data-line-number="15"><span class="kw">margin-bottom</span>: <span class="dv">1em</span>; <span class="kw">background</span>: <span class="dv">#fafafa</span>; }</a>
<a class="sourceLine" id="cb34-16" data-line-number="16"><span class="fu">.flash</span>          { <span class="kw">background</span>: <span class="dv">#cee5F5</span>; <span class="kw">padding</span>: <span class="dv">0.5em</span>;</a>
<a class="sourceLine" id="cb34-17" data-line-number="17"><span class="kw">border</span>: <span class="dv">1px</span> <span class="dv">solid</span> <span class="dv">#aacbe2</span>; }</a>
<a class="sourceLine" id="cb34-18" data-line-number="18"><span class="fu">.error</span>          { <span class="kw">background</span>: <span class="dv">#f0d6d6</span>; <span class="kw">padding</span>: <span class="dv">0.5em</span>; }</a></code></pre></div></li>
</ul>
<h2 id="εκκίνηση">Εκκίνηση</h2>
<ul>
<li>Τα βήματα για την εκκίνηση της εφαρμογής παραμένουν ως είχαν και προηγούμενως.</li>
</ul>
<h1 id="χειρισμός-κωδικών">Χειρισμός Κωδικών</h1>
<h2 id="το-πρόβλημα">Το πρόβλημα</h2>
<ul>
<li><p>Μέχρι τώρα, οι κωδικοί των χρηστών αποθηκεύονται στη βάση έτσι όπως ακριβώς δίνονται.</p></li>
<li><p>Αυτό είναι τεράστιο πρόβλημα ασφαλείας.</p></li>
<li><p>Οι κωδικοί πρέπει να αποθηκεύονται με τρόπο τέτοιο ώστε να μην είναι δυνατόν να διαπιστωθούν τα περιεχόμενά τους, ακόμα και αν έχουμε πλήρη πρόσβαση στη βάση.</p></li>
<li><p>Για το σκοπό αυτό οι κωδικοί κρυπτογραφούνται με κατάλληλη συνάρτητη κατακερματισμού.</p></li>
</ul>
<h2 id="bcrypt">Bcrypt</h2>
<ul>
<li><p>Για την κρυπτογράφηση των κωδικών θα χρησιμοποιήσουμε τη συνάρτηση <a href="https://en.wikipedia.org/wiki/Bcrypt">bcrypt</a>.</p></li>
<li><p>Η συνάρτηση αυτή παίρνει ως είσοδο μια συμβολοσειρά και μία τυχαία σειρά 128 bits που ονομάζεται <em>αλάτι</em> (salt).</p></li>
<li><p>Με βάση αυτά, παράγει ως έξοδο μια σειρά από 60 bytes από τα οποία δεν μπορούμε να βρούμε τι είχε δοθεί ως είσοδος.</p></li>
</ul>
<div class="notes">
<p>Το αλάτι είναι απαραίτητο για τον εξής λόγο. Κάποιος μπορεί απλώς να αρχίσει να μαντεύει δημοφιλείς κωδικούς. Αφού όμως στον κωδικό του χρήστη μπαίνει και το αλάτι, κάποιος θα πρέπει να μαντέψει εκτός από τον κωδικό και το αλάτι, που είναι πολύ απίθανο.</p>
<p>Όταν θέλουμε να ελέγξουμε έναν κωδικό, τον εισάγουμε στη συνάρτηση ελέγχου, μαζί με το αλάτι, και περιμένουμε να βρούμε τον (κρυπτογραφημένο) κωδικό που έχουμε αποθηκεύσει.</p>
</div>
<h2 id="εγκατάσταση-bcrypt">Εγκατάσταση bcrypt</h2>
<ul>
<li><p>Κατ’ αρχήν θα πρέπει να εγκαταστήσουμε τη βιβλιοθήκη bcrypt.</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb35-1" data-line-number="1"><span class="ex">pip</span> install bcrypt</a></code></pre></div></li>
</ul>
<h2 id="δημιουργία-περιβάλλοντος-2">Δημιουργία περιβάλλοντος</h2>
<ul>
<li><p>Δημιουργείστε την παρακάτω δομή καταλόγων.</p>
<pre><code>/flaskr_orm_3
    /static
    /templates</code></pre></li>
</ul>
<div class="notes">
<p>Πρόκειται για τη γνωστή δομή, δεν αλλάζει κάτι εκτός από το όνομα του βασικού καταλόγου.</p>
</div>
<h2 id="δημιουργία-βάσης-2">Δημιουργία βάσης</h2>
<ul>
<li><p>Όπως και πριν, δίνουμε:</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb37-1" data-line-number="1"><span class="op">&gt;&gt;&gt;</span> <span class="im">from</span> flaskr <span class="im">import</span> db</a>
<a class="sourceLine" id="cb37-2" data-line-number="2"><span class="op">&gt;&gt;&gt;</span> db.create_all()</a></code></pre></div></li>
</ul>
<h2 id="φόρμα-εγγραφής">Φόρμα εγγραφής</h2>
<ul>
<li><p>Αυτή τη φορά θα εμπλουτίσουμε την εφαρμογή με τη δυνατότητα online εγγραφής χρηστών.</p></li>
<li><p>Η φόρμα εγγραφής θα είναι η ακόλουθη, την οποία θα την αποθηκεύσουμε με το όνομα <code>register.html</code> στον κατάλογο <code>templates</code>.</p></li>
</ul>
<h2 id="κώδικας-φόρμας">Κώδικας φόρμας</h2>
<div class="sourceCode" id="cb38"><pre class="sourceCode html"><code class="sourceCode html"><a class="sourceLine" id="cb38-1" data-line-number="1">{% extends &quot;layout.html&quot; %}</a>
<a class="sourceLine" id="cb38-2" data-line-number="2">{% block body %}</a>
<a class="sourceLine" id="cb38-3" data-line-number="3">  <span class="kw">&lt;h2&gt;</span>Register<span class="kw">&lt;/h2&gt;</span></a>
<a class="sourceLine" id="cb38-4" data-line-number="4">  {% if error %}</a>
<a class="sourceLine" id="cb38-5" data-line-number="5">    <span class="kw">&lt;p</span><span class="ot"> class=</span><span class="st">error</span><span class="kw">&gt;&lt;strong&gt;</span>Error:<span class="kw">&lt;/strong&gt;</span> {{ error }}</a>
<a class="sourceLine" id="cb38-6" data-line-number="6">  {% endif %}</a>
<a class="sourceLine" id="cb38-7" data-line-number="7">  <span class="kw">&lt;form</span><span class="ot"> action=</span><span class="st">&quot;{{ url_for('register') }}&quot;</span><span class="ot"> method=</span><span class="st">post</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb38-8" data-line-number="8">    <span class="kw">&lt;dl&gt;</span></a>
<a class="sourceLine" id="cb38-9" data-line-number="9">      <span class="kw">&lt;dt&gt;</span>Name:</a>
<a class="sourceLine" id="cb38-10" data-line-number="10">      <span class="kw">&lt;dd&gt;&lt;input</span><span class="ot"> type=</span><span class="st">text</span><span class="ot"> name=</span><span class="st">name</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb38-11" data-line-number="11">      <span class="kw">&lt;dt&gt;</span>Surname:</a>
<a class="sourceLine" id="cb38-12" data-line-number="12">      <span class="kw">&lt;dd&gt;&lt;input</span><span class="ot"> type=</span><span class="st">text</span><span class="ot"> name=</span><span class="st">surname</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb38-13" data-line-number="13">      <span class="kw">&lt;dt&gt;</span>email:</a>
<a class="sourceLine" id="cb38-14" data-line-number="14">      <span class="kw">&lt;dd&gt;&lt;input</span><span class="ot"> type=</span><span class="st">email</span><span class="ot"> name=</span><span class="st">email</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb38-15" data-line-number="15">      <span class="kw">&lt;dt&gt;</span>Username:</a>
<a class="sourceLine" id="cb38-16" data-line-number="16">      <span class="kw">&lt;dd&gt;&lt;input</span><span class="ot"> type=</span><span class="st">text</span><span class="ot"> name=</span><span class="st">username</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb38-17" data-line-number="17">      <span class="kw">&lt;dt&gt;</span>Password:</a>
<a class="sourceLine" id="cb38-18" data-line-number="18">      <span class="kw">&lt;dd&gt;&lt;input</span><span class="ot"> type=</span><span class="st">password</span><span class="ot"> name=</span><span class="st">password</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb38-19" data-line-number="19">      <span class="kw">&lt;dt&gt;</span>Repeat Password:</a>
<a class="sourceLine" id="cb38-20" data-line-number="20">      <span class="kw">&lt;dd&gt;&lt;input</span><span class="ot"> type=</span><span class="st">password</span><span class="ot"> name=</span><span class="st">repeat-password</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb38-21" data-line-number="21">      <span class="kw">&lt;dd&gt;&lt;input</span><span class="ot"> type=</span><span class="st">submit</span><span class="ot"> value=</span><span class="st">Register</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb38-22" data-line-number="22">    <span class="kw">&lt;/dl&gt;</span></a>
<a class="sourceLine" id="cb38-23" data-line-number="23">  <span class="kw">&lt;/form&gt;</span></a>
<a class="sourceLine" id="cb38-24" data-line-number="24">{% endblock %}</a></code></pre></div>
<h2 id="εγγραφή-χρηστών">Εγγραφή χρηστών</h2>
<ul>
<li><p>Ο χειρισμός της εγγραφής θα γίνεται από την ακόλουθη συνάρτηση, η οποία θα απαντά σε αιτήσεις στο μονοπάτι <code>/register</code>.</p></li>
<li><p>Προσέξτε ότι θα πρέπει στο προοίμιο της εφαρμογής να προσθέσετε τη γραμμή:</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb39-1" data-line-number="1"><span class="im">from</span> sqlalchemy <span class="im">import</span> exc</a></code></pre></div>
<p>Αυτό θα το χρησιμοποιήσουμε για το χειρισμό λαθών.</p></li>
<li><p>Συγκεκριμένα, θα χειριστούμε προβλήματα τα οποία μπορεί να εμφανιστούν κατά την εισαγωγή χρηστών στη βάση δεδομένων· η βάση δεν θα επιτρέψει την εισαγωγή δύο χρηστών με το ίδιο username και αυτό θα το λάβουμε ως μία εξαίρεση (exception) από το SQLAlchemy.</p></li>
</ul>
<h2 id="κώδικας-εγγραφής">Κώδικας εγγραφής</h2>
<div class="sourceCode" id="cb40"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb40-1" data-line-number="1"><span class="at">@app.route</span>(<span class="st">'/register'</span>, methods<span class="op">=</span>[<span class="st">'GET'</span>, <span class="st">'POST'</span>])</a>
<a class="sourceLine" id="cb40-2" data-line-number="2"><span class="kw">def</span> register():</a>
<a class="sourceLine" id="cb40-3" data-line-number="3">    error <span class="op">=</span> <span class="va">None</span></a>
<a class="sourceLine" id="cb40-4" data-line-number="4">    <span class="cf">if</span> request.method <span class="op">==</span> <span class="st">'POST'</span>:</a>
<a class="sourceLine" id="cb40-5" data-line-number="5">        <span class="cf">if</span> request.form[<span class="st">'password'</span>] <span class="op">!=</span> request.form[<span class="st">'repeat-password'</span>]:</a>
<a class="sourceLine" id="cb40-6" data-line-number="6">            error <span class="op">=</span> <span class="st">'Passwords do not match'</span></a>
<a class="sourceLine" id="cb40-7" data-line-number="7">        <span class="cf">else</span>:</a>
<a class="sourceLine" id="cb40-8" data-line-number="8">            password <span class="op">=</span> bcrypt.hashpw(request.form[<span class="st">'password'</span>].encode(<span class="st">'utf8'</span>),</a>
<a class="sourceLine" id="cb40-9" data-line-number="9">                                     bcrypt.gensalt())</a>
<a class="sourceLine" id="cb40-10" data-line-number="10">            user <span class="op">=</span> User(username<span class="op">=</span>request.form[<span class="st">'username'</span>],</a>
<a class="sourceLine" id="cb40-11" data-line-number="11">                        name<span class="op">=</span>request.form[<span class="st">'name'</span>],</a>
<a class="sourceLine" id="cb40-12" data-line-number="12">                        surname<span class="op">=</span>request.form[<span class="st">'surname'</span>],</a>
<a class="sourceLine" id="cb40-13" data-line-number="13">                        email<span class="op">=</span>request.form[<span class="st">'email'</span>],</a>
<a class="sourceLine" id="cb40-14" data-line-number="14">                        password<span class="op">=</span>password)</a>
<a class="sourceLine" id="cb40-15" data-line-number="15">            db.session.add(user)</a>
<a class="sourceLine" id="cb40-16" data-line-number="16">            <span class="cf">try</span>:</a>
<a class="sourceLine" id="cb40-17" data-line-number="17">                db.session.commit()</a>
<a class="sourceLine" id="cb40-18" data-line-number="18">                session[<span class="st">'user_id'</span>] <span class="op">=</span> user.<span class="bu">id</span></a>
<a class="sourceLine" id="cb40-19" data-line-number="19">                session[<span class="st">'username'</span>] <span class="op">=</span> user.username</a>
<a class="sourceLine" id="cb40-20" data-line-number="20">            <span class="cf">except</span> exc.SQLAlchemyError <span class="im">as</span> ex:</a>
<a class="sourceLine" id="cb40-21" data-line-number="21">                error <span class="op">=</span> <span class="st">'Error inserting record in the database'</span></a>
<a class="sourceLine" id="cb40-22" data-line-number="22">                app.logger.error(ex)</a>
<a class="sourceLine" id="cb40-23" data-line-number="23">        <span class="cf">if</span> <span class="kw">not</span> error:</a>
<a class="sourceLine" id="cb40-24" data-line-number="24">            flash(<span class="st">'Registration successful'</span>)</a>
<a class="sourceLine" id="cb40-25" data-line-number="25">            <span class="cf">return</span> redirect(url_for(<span class="st">'show_entries'</span>))</a>
<a class="sourceLine" id="cb40-26" data-line-number="26">    <span class="cf">return</span> render_template(<span class="st">'register.html'</span>, error<span class="op">=</span>error)</a></code></pre></div>
<div class="notes">
<p>Η κρυπτογράφηση του κωδικού του χρήστη γίνεται με την εντολή:</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb41-1" data-line-number="1">password <span class="op">=</span> bcrypt.hashpw(request.form[<span class="st">'password'</span>].encode(<span class="st">'utf8'</span>),</a>
<a class="sourceLine" id="cb41-2" data-line-number="2">                         bcrypt.gensalt())</a></code></pre></div>
<p>Η πρώτη παράμετρος της συνάρτησης είναι ο κωδικός. Αυτός είναι η συμβολοσειρά που έχει εισαχθεί από τον χρήστη. Η bcrypt όμως ως είσοδο παίρνει μια σειρά από bytes, και όχι χαρακτήρες. Συνεπώς μετατρέπουμε τη συμβολοσειρά σε σειρά από bytes με την κλήση <code>request.form['password'].encode('utf8')</code>.</p>
<p>Η δεύτερη παράμετρος της συνάρτησης είναι το αλάτι, το οποίο παράγεται με την κλήση <code>bcrypt.gensalt()</code>.</p>
<p>Στη συνέχεια δημιουργούμε το αντικείμενο που θα αντιπροσωπεύει το χρήστη και το αποθηκεύουμε στη βάση. Υπάρχει πάντα η περίπτωση κάτι τέτοιο να μη γίνει: για παράδειγμα, κάποιος δίνει <code>username</code> το οποίο ήδη υπάρχει. Αν συμβεί οποιοδήποτε λάθος σχετικό με τη βάση δεδομένων, θα λάβουμε μία εξαίρεση <code>SQLAlchemyError</code>, συνεπώς τη χειριζόμαστε και εμφανίζουμε κατάλληλο μήνυμα. Μέχρι τώρα αδιαφορούσαμε για τέτοια προβλήματα, αλλά σιγά-σιγά θα πρέπει να αρχίσουμε να τα αντιμετωπίζουμε.</p>
</div>
<h2 id="είσοδος-2">Είσοδος</h2>
<ul>
<li><p>Η διαδικασία εισόδου του χρήστη θα πρέπει να αλλάξει ελαφρώς, προκειμένου να ελέγχεται ο κρυπτογραφημένος κωδικός.</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb42-1" data-line-number="1"><span class="at">@app.route</span>(<span class="st">'/login'</span>, methods<span class="op">=</span>[<span class="st">'GET'</span>, <span class="st">'POST'</span>])</a>
<a class="sourceLine" id="cb42-2" data-line-number="2"><span class="kw">def</span> login():</a>
<a class="sourceLine" id="cb42-3" data-line-number="3">    error <span class="op">=</span> <span class="va">None</span></a>
<a class="sourceLine" id="cb42-4" data-line-number="4">    <span class="cf">if</span> request.method <span class="op">==</span> <span class="st">'POST'</span>:</a>
<a class="sourceLine" id="cb42-5" data-line-number="5">        user <span class="op">=</span> User.query.filter_by(</a>
<a class="sourceLine" id="cb42-6" data-line-number="6">            username<span class="op">=</span>request.form[<span class="st">'username'</span>]).one_or_none():</a>
<a class="sourceLine" id="cb42-7" data-line-number="7">        <span class="cf">if</span> user <span class="kw">is</span> <span class="va">None</span>:</a>
<a class="sourceLine" id="cb42-8" data-line-number="8">            error <span class="op">=</span> <span class="st">'Invalid username'</span></a>
<a class="sourceLine" id="cb42-9" data-line-number="9">        <span class="cf">elif</span> <span class="kw">not</span> bcrypt.checkpw(request.form[<span class="st">'password'</span>].encode(<span class="st">'utf8'</span>),</a>
<a class="sourceLine" id="cb42-10" data-line-number="10">            user.password):</a>
<a class="sourceLine" id="cb42-11" data-line-number="11">            error <span class="op">=</span> <span class="st">'Invalid password'</span></a>
<a class="sourceLine" id="cb42-12" data-line-number="12">        <span class="cf">else</span>:</a>
<a class="sourceLine" id="cb42-13" data-line-number="13">            session[<span class="st">'user_id'</span>] <span class="op">=</span> user.<span class="bu">id</span></a>
<a class="sourceLine" id="cb42-14" data-line-number="14">            session[<span class="st">'username'</span>] <span class="op">=</span> user.username</a>
<a class="sourceLine" id="cb42-15" data-line-number="15">            flash(<span class="st">'You have been logged in'</span>)</a>
<a class="sourceLine" id="cb42-16" data-line-number="16">            <span class="cf">return</span> redirect(url_for(<span class="st">'show_entries'</span>))</a>
<a class="sourceLine" id="cb42-17" data-line-number="17">    <span class="cf">return</span> render_template(<span class="st">'login.html'</span>, error<span class="op">=</span>error)</a></code></pre></div></li>
</ul>
<div class="notes">
<p>Για τον έλεγχο του κωδικού χρησιμοποιούμε την εντολή:</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb43-1" data-line-number="1">bcrypt.checkpw(request.form[<span class="st">'password'</span>].encode(<span class="st">'utf8'</span>),</a>
<a class="sourceLine" id="cb43-2" data-line-number="2">               user.password.encode(<span class="st">'utf8'</span>))</a></code></pre></div>
<p>H συνάρτηση <code>bcrypt.checkpw</code> παίρνει ως πρώτη παράμετρο αυτό που θέλουμε να ελέγξουμε και ως δεύτερη αυτό με το οποίο θα πρέπει να είναι ίσο. Θέλουμε να ελέγξουμε τον κωδικό που έχει εισάγει ο χρήστης στη φόρμα, σε σχέση με τον κωδικό που έχει αποθηκευτεί στη βάση. Επειδή η <code>bcrypt.checkpw</code> λειτουργεί με bytes, και όχι με συμβολοσειρές, θα πρέπει να μετατρέψουμε τις τιμές των παραμέτρων σε bytes με την <code>encode('utf8')</code>.</p>
</div>
<h2 id="βασικό-πρότυπο-εμφάνισης-1">Βασικό πρότυπο εμφάνισης</h2>
<ul>
<li><p>Το βασικό πρότυπο εμφάνισης επίσης πρέπει να αλλαχθεί λίγο, ώστε στο πάνω μέρος να εμφανίζουμε όταν πρέπει το σύνδεσμο για είσοδο ή για εγγραφή.</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode html"><code class="sourceCode html"><a class="sourceLine" id="cb44-1" data-line-number="1"><span class="dt">&lt;!doctype </span>html<span class="dt">&gt;</span></a>
<a class="sourceLine" id="cb44-2" data-line-number="2"><span class="kw">&lt;title&gt;</span>Flaskr<span class="kw">&lt;/title&gt;</span></a>
<a class="sourceLine" id="cb44-3" data-line-number="3"><span class="kw">&lt;link</span><span class="ot"> rel=</span><span class="st">stylesheet</span><span class="ot"> type=</span><span class="st">text/css</span></a>
<a class="sourceLine" id="cb44-4" data-line-number="4"><span class="ot">      href=</span><span class="st">&quot;{{ url_for('static', filename='style.css') }}&quot;</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb44-5" data-line-number="5"><span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">page</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb44-6" data-line-number="6">  <span class="kw">&lt;h1&gt;</span>Flaskr<span class="kw">&lt;/h1&gt;</span></a>
<a class="sourceLine" id="cb44-7" data-line-number="7">  <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">metanav</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb44-8" data-line-number="8">  {% if not session.user_id %}</a>
<a class="sourceLine" id="cb44-9" data-line-number="9">    <span class="kw">&lt;a</span><span class="ot"> href=</span><span class="st">&quot;{{ url_for('login') }}&quot;</span><span class="kw">&gt;</span>log in<span class="kw">&lt;/a&gt;</span></a>
<a class="sourceLine" id="cb44-10" data-line-number="10">    {% if request.path != '/register' %} </a>
<a class="sourceLine" id="cb44-11" data-line-number="11">      or</a>
<a class="sourceLine" id="cb44-12" data-line-number="12">      <span class="kw">&lt;a</span><span class="ot"> href=</span><span class="st">&quot;{{ url_for('register') }}&quot;</span><span class="kw">&gt;</span>register<span class="kw">&lt;/a&gt;</span></a>
<a class="sourceLine" id="cb44-13" data-line-number="13">    {% endif %}</a>
<a class="sourceLine" id="cb44-14" data-line-number="14">  {% else %}</a>
<a class="sourceLine" id="cb44-15" data-line-number="15">    <span class="kw">&lt;a</span><span class="ot"> href=</span><span class="st">&quot;{{ url_for('logout') }}&quot;</span><span class="kw">&gt;</span>log out<span class="kw">&lt;/a&gt;</span></a>
<a class="sourceLine" id="cb44-16" data-line-number="16">  {% endif %}</a>
<a class="sourceLine" id="cb44-17" data-line-number="17">  <span class="kw">&lt;/div&gt;</span></a>
<a class="sourceLine" id="cb44-18" data-line-number="18">  {% for message in get_flashed_messages() %}</a>
<a class="sourceLine" id="cb44-19" data-line-number="19">    <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">flash</span><span class="kw">&gt;</span>{{ message }}<span class="kw">&lt;/div&gt;</span></a>
<a class="sourceLine" id="cb44-20" data-line-number="20">  {% endfor %}</a>
<a class="sourceLine" id="cb44-21" data-line-number="21">  {% block body %}{% endblock %}</a>
<a class="sourceLine" id="cb44-22" data-line-number="22"><span class="kw">&lt;/div&gt;</span></a></code></pre></div></li>
</ul>
<div class="notes">
<p>Συγκεκριμένα, αν ο χρήστης δεν έχει περάσει τη διαδικασία εισόδου και η σελίδα που θέλει να δει στην εφαρμογή δεν αντιστοιχεί στο μονοπάτι <code>/register</code>, τότε θέλουμε να του παρέχουμε δύο επιλογές, μία για είσοδο και μία για εγγραφή. Αν όμως αντιστοιχεί στο μονοπάτι <code>/register</code>, τότε θέλουμε να του δώσουμε μόνο τη δυνατότητα εισόδου (π.χ., γιατί ξαφνικά θυμήθηκε ότι έχει από παλαιότερα κωδικό εισόδου).</p>
</div>
<h1 id="mysql">MySQL</h1>
<h2 id="γενικά-3">Γενικά</h2>
<ul>
<li><p>Η SQLite είναι μια πολύ βολική λύση, αλλά το πιθανότερο είναι ότι θα θέλουμε να χρησιμοποιήσουμε μια άλλη βάση δεδομένων στην παραγωγή.</p></li>
<li><p>Για το σκοπό αυτό, θα κάνουμε τις απαραίτητες αλλαγές στην εφαρμογή μας ώστε να χρησιμοποιήσει τη βάση δεδομένων MySQL.</p></li>
<li><p>Χάρη στο ORM θα διαπιστώσετε ότι οι αλλαγές είναι ελάχιστες.</p></li>
</ul>
<h2 id="δημιουργία-περιβάλλοντος-3">Δημιουργία περιβάλλοντος</h2>
<ul>
<li><p>Αντιγράψτε τη δομή καταλόγων και τα αρχεία που δημιουργήσατε για το <code>flaskr_orm_3</code> σε έναν κατάλογο <code>flaskr_orm_4</code>.</p>
<pre><code>/flaskr_orm_4
    /static
    /templates</code></pre></li>
<li><p>Δεν θα πειράξουμε καθόλου τα υπάρχοντα αρχεία, όπως θα δείτε. Απλώς θα προσθέσουμε μόνο ένα.</p></li>
</ul>
<h2 id="εγκατάσταση-mysql">Εγκατάσταση MySQL</h2>
<ul>
<li><p>Πηγαίνετε στο <a href="http://dev.mysql.com/downloads/" class="uri">http://dev.mysql.com/downloads/</a> και κατεβάστε την τελευταία έκδοση του MySQL Community Server.</p></li>
<li><p>Επίσης, πηγαίνετε στο <a href="http://dev.mysql.com/downloads/" class="uri">http://dev.mysql.com/downloads/</a> και κατεβάστε την τελευταία έκδοση του MySQL Workbench.</p></li>
</ul>
<h2 id="εγκατάσταση-οδηγού">Εγκατάσταση οδηγού</h2>
<ul>
<li><p>Για να επικοινωνήσουμε με τη MySQL από προγράμματα Python χρειαζόμαστε τον κατάλληλο <em>οδηγό</em> (driver).</p></li>
<li><p>Από το <a href="http://dev.mysql.com/downloads/connector/python/">Connector/Python</a> επιλέξτε και κατεβάστε την έκδοση “Platform Independent”.</p></li>
<li><p>Όταν τον αποσυμπιέσετε, θα πρέπει να ανοίξετε μια γραμμή εντολών και να πάτε στον κατάλογο όπου τον αποσυμπιέσατε.</p></li>
<li><p>Στον κατάλογο αυτό, θα πρέπει να δώσετε:</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb46-1" data-line-number="1"><span class="ex">python</span> setup.py install</a></code></pre></div></li>
</ul>
<div class="notes">
<p>Σε μία επαγγελματική εφαρμογή, θα θέλατε να χρησιμοποιήσετε τον οδηγό με τις επεκτάσεις της γλώσσας C. Μπορείτε να βρείτε τις σχετικές οδηγίες <a href="https://dev.mysql.com/doc/connector-python/en/connector-python-installation-source.html">εδώ</a>.</p>
</div>
<h2 id="δημιουργία-βάσης-3">Δημιουργία βάσης</h2>
<ul>
<li><p>Δημιουργείστε τη βάση <code>flaskr</code> εισάγοντας τις ακόλουθες εντολές SQL στον MySQL Workbench:</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb47-1" data-line-number="1"><span class="kw">CREATE</span> <span class="kw">DATABASE</span> flaskr <span class="dt">CHARACTER</span> <span class="kw">SET</span> utf8 COLLATE utf8_general_ci;</a>
<a class="sourceLine" id="cb47-2" data-line-number="2"></a>
<a class="sourceLine" id="cb47-3" data-line-number="3"><span class="kw">CREATE</span> <span class="fu">USER</span> <span class="st">'flaskr_user'</span>@<span class="st">'localhost'</span> <span class="kw">IDENTIFIED</span> <span class="kw">BY</span> <span class="st">'aojkqw3m2t'</span>;</a>
<a class="sourceLine" id="cb47-4" data-line-number="4"></a>
<a class="sourceLine" id="cb47-5" data-line-number="5"><span class="kw">GRANT</span> <span class="kw">ALL</span> <span class="kw">PRIVILEGES</span> <span class="kw">ON</span> flaskr.* <span class="kw">TO</span> <span class="st">'flaskr_user'</span>@<span class="st">'localhost'</span>;</a></code></pre></div></li>
</ul>
<h2 id="ρύθμιση-για-χρήση-mysql">Ρύθμιση για χρήση MySQL</h2>
<ul>
<li><p>Δημιουργείστε στον κατάλογο <code>flaskr_orm_4</code> ένα αρχείο <code>config.py</code> στο οποίο θα εισάγετε την παρακάτω γραμμή:</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb48-1" data-line-number="1">SQLALCHEMY_DATABASE_URI <span class="op">=</span> <span class="st">'mysql+mysqlconnector://flaskr_user:aojkqw3m2t@localhost/flaskr'</span></a></code></pre></div></li>
<li><p>Στη συνέχεια, αν έχετε υπολογιστή MS-Windows, δώστε το παρακάτω στη γραμμή εντολών:</p>
<pre><code>set FLASKR_SETTINGS=config.py</code></pre></li>
<li><p>Αν έχετε υπολογιστή Linux ή Mac, δώστε το παρακάτω στη γραμμή εντολών:</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb50-1" data-line-number="1"><span class="bu">export</span> <span class="va">FLASKR_SETTINGS=</span>config.py</a></code></pre></div></li>
</ul>
<div class="notes">
<p>Αυτό εξηγεί τη σημασία της γραμμής:</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb51-1" data-line-number="1">app.config.from_envvar(<span class="st">'FLASKR_SETTINGS'</span>, silent<span class="op">=</span><span class="va">True</span>)</a></code></pre></div>
<p>στο προοίμιο της εφαρμογής μας. Σημαίνει: αν βρεις ένα αρχείο, το οποίο να δίνεται από τη μεταβλητή περιβάλλοντος <code>FLASKR_SETTINGS</code>, πάρε τα περιεχόμενά του και ενημέρωσε τις ρυθμίσεις της εφαρμογής με αυτά.</p>
<p>Οπότε αν βρεθεί το αρχείο <code>config.py</code>, θα χρησιμοποιηθεί η βάση MySQL. Αν όχι, θα χρησιμοποιηθεί η SQLite.</p>
</div>
<h2 id="δημιουργία-πινάκων">Δημιουργία πινάκων</h2>
<ul>
<li><p>Για να δημιουργήσουμε τους πίνακες της βάσης μας (entries, users) μπορούμε και πάλι να χρησιμοποιήσουμε τη γραμμή εντολών Python:</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb52-1" data-line-number="1"><span class="op">&gt;&gt;&gt;</span> <span class="im">from</span> flaskr <span class="im">import</span> db</a>
<a class="sourceLine" id="cb52-2" data-line-number="2"><span class="op">&gt;&gt;&gt;</span> db.create_all()</a></code></pre></div></li>
</ul>
<h2 id="δημιουργία-πινάκων-1">Δημιουργία πινάκων</h2>
<ul>
<li><p>Εναλλακτικά, μπορούμε να δημιουργήσουμε την αντίστοιχη εντολή, προσθέτοντας στο αρχείο <code>flaskr.py</code>:</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb53-1" data-line-number="1"><span class="at">@app.cli.command</span>(<span class="st">'initdb'</span>)</a>
<a class="sourceLine" id="cb53-2" data-line-number="2"><span class="kw">def</span> initdb_command():</a>
<a class="sourceLine" id="cb53-3" data-line-number="3">    <span class="co">&quot;&quot;&quot;Initializes the database.&quot;&quot;&quot;</span></a>
<a class="sourceLine" id="cb53-4" data-line-number="4">    db.create_all()</a>
<a class="sourceLine" id="cb53-5" data-line-number="5">    <span class="bu">print</span>(<span class="st">'Initialized the database.'</span>)</a></code></pre></div></li>
<li><p>Οπότε μπορούμε να δώσουμε από τη γραμμή εντολών:</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb54-1" data-line-number="1"><span class="ex">flask</span> initdb</a></code></pre></div></li>
<li><p>Αυτό θα μπορούσαμε να το είχαμε κάνει προηγουμένως με την SQLite· απλώς προτιμούσαμε να χρησιμοποιούμε τη γραμμή εντολών της Python.</p></li>
</ul>
<h2 id="επόμενα-βήματα">Επόμενα βήματα</h2>
<ul>
<li>Δεν υπάρχουν!</li>
</ul>
<div class="notes">
<p>Όπως είδατε, η μόνη αλλαγή που χρειάστηκε ήταν η δημιουργία ενός αρχείου και μιας μεταβλητής περιβάλλοντος. Δεν άλλαξε τίποτε στην ίδια την εφαρμογή μας.</p>
<p>Αν στη συνέχεια θέλουμε να χρησιμοποιήσουμε μια άλλη βάση, όπως SQL Server, Oracle, PostreSQL, κ.λπ., αρκεί μόνο να αλλάξουμε τα περιεχόμενα του αρχείου <code>config.py</code> και τίποτε άλλο.</p>
</div>
</body>
</html>
